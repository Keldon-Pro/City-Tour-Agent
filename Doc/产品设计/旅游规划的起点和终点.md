# 旅游规划的起点与终点（产品设计草案）

> 核心一句话：把用户一句句 / 一栏栏填写的“旅行信息表”转化为一份结构化、可交互、可优化迭代的“行程表”。

---

## 1. 起点：旅行信息表（Input Profile）
用户在左侧“旅行信息”面板中提供的所有字段集合，是规划算法的唯一可信原始数据源。它决定了规划空间与约束边界。

### 1.1 核心字段分类
| 分类 | 字段/来源 | 说明 | 作用 |
|------|-----------|------|------|
| 时间范围 | 出发日期、结束日期 | 计算旅行天数 N | 决定行程 day 框架与可排布槽位 |
| 人群构成 | 总人数、特殊群体（儿童/老人等） | 推导适配性 | 影响推荐（例如强度、亲子/老友/长者友好型地点） |
| 预算 | 总预算（不含往返） | 可选：均摊到天/人 | 控制消费层级（餐饮/住宿/活动） |
| 旅行目的 | 复选 + 其他自由文本 | 场景偏好向量 | 影响目的地类别与活动权重 |
| 其他补充 | “其他”文本域 | 语义解析成标签或硬性约束 | 提升个性化、生成说明 |

### 1.2 数据质量与预处理
- 校验：日期合法性（结束 >= 开始）、人数为正整数、预算非负。
- 归一：目的标签 → 标准化枚举；自由文本 → 关键词 + Embedding。
- 推断：若未填写预算，可用默认区间 / 通过用户画像（历史）估计。
- 标注：生成一个 planning_session_id，写入 localStorage / 后端，支持恢复与追踪。

### 1.3 结构化表示（示例 JSON）
```json
{
	"session_id": "sess_20250218_xxxx",
	"date_range": { "start": "2025-02-18", "end": "2025-02-21", "days": 4 },
	"party": { "total": 3, "children_u5": 1, "children_5_12": 0, "elderly": 0 },
	"budget": { "total": 3000, "currency": "CNY", "per_day_estimate": 750 },
	"purposes": ["亲子游玩", "美食探索"],
	"extra_text": "想安排一次海边日落拍照",
	"derived_tags": ["亲子", "美食", "摄影", "海边日落"],
	"constraints": { "pace": "moderate", "max_daily_spots": 6 }
}
```

---

## 2. 终点：行程表（Structured Itinerary）
行程表是“具备时间/顺序/备注/可交互编辑”的多天计划集合，并允许后续 AI / 用户双向迭代。

### 2.1 行程表核心结构
| 维度 | 字段 | 说明 |
|------|------|------|
| 元信息 | id, title, created_at, updated_at | 用于版本管理与同步 |
| 天 | date, day_number | 自 startDate 起连续递增 |
| 地点 | address, time, notes, fixed, visit_order | 基础显示 + 拖拽/编辑标记 |
| 可扩展 | category, cost_estimate, duration, geo, tags | 未来增强推荐与验证 |

### 2.2 目标特性
- 可读：时间 + 中文星期 + 序号（第 X 天）。
- 可操作：拖拽排序 / 跨天移动 / 固定（不被 AI 覆盖）。
- 可追踪：每次修改触发 updated_at、可选生成 diff。
- 可智能：后续 AI 调整只修改“非 fixed”节点。

### 2.3 示例结构
```json
{
	"itinerary": {
		"id": "itinerary_1736655555_abcd123",
		"title": "海口亲子美食四日行",
		"days": [
			{
				"date": "2025-02-18",
				"day_number": 1,
				"locations": [
					{ "address": "骑楼老街", "time": "09:30", "notes": "早餐后慢逛", "fixed": false, "visit_order": 1 },
					{ "address": "海口骑楼小吃一条街", "time": "12:00", "notes": "特色午餐", "fixed": false, "visit_order": 2 }
				]
			}
		]
	}
}
```

---

## 3. 从起点到终点：信息流概览
```
旅行信息表输入  →  预处理/归一化  →  兴趣 & 约束表示 (向量/标签/规则)  →  候选地点库过滤  →  评分与选取  →  天粒度分配  →  日内排序/节奏调和  →  行程表初稿  →  AI 解释/用户确认  →  迭代优化
```

### 3.1 关键映射
| 输入因素 | 影响逻辑 | 结果字段 |
|----------|----------|----------|
| 旅行目的 | 加权类别（美食/文化/亲子等） | 候选集合评分 |
| 人群构成 | 过滤“不适宜”地点；限制日内强度 | max_daily_spots / category ban |
| 预算 | 低/中/高档餐饮与付费景点比例 | cost_estimate 分配 |
| 日期跨度 | 天数 × 时段槽位 | days[].locations 容量 |
| 自由文本 | 解析意图（摄影、日落、轻松） | special_tag → 插入特定锚点 |

---

## 4. 规划生成流程（算法阶段）
| 阶段 | 目的 | 产出 |
|------|------|------|
| A. 解析 | 清洗 & 结构化 | 标准化 Profile 对象 |
| B. 候选扩展 | 拉取本地/缓存/向量检索地点 | 候选地点列表 (K) |
| C. 过滤 | 规则 + 黑名单 + 适宜度 | 合格集合 |
| D. 评分 | 多维打分：主题匹配、地理聚类、口碑、时段合理性 | 排序列表 |
| E. 选点 | 多样性 + 覆盖优先 | 每天初始点集 |
| F. 排序 | 旅行动线（地理/时间）、节奏（动静交替） | visit_order/time 建议 |
| G. 约束修正 | 超量/冲突回溯 | 可行解 |
| H. 标注 | 生成 notes/说明/建议 | 丰富项 |
| I. 输出 | 结构化 JSON + 人类可读副文本 | 行程表初稿 |

---

## 5. 约束与规则
### 5.1 硬约束 (Hard)
- 日期范围内不得越界。
- 固定节点 (fixed) 不被重排/删除。
- 单天地点数 ≤ max_daily_spots（默认 6，可随人群调整）。
- 同一地址重复出现需显式理由，否则去重。

### 5.2 软约束 (Soft)
- 早晚时段安排轻体验，中段安排核心体验。
- 连续两个强体力/高刺激活动之间建议插入“缓冲节点”。
- 美食节点：午餐 11:00–13:30；晚餐 17:30–20:00 优先。
- 儿童/老人行程：每日首个活动不早于 08:30，晚间结束不晚于 21:00。

---

## 6. 实现策略（迭代路线）
### 6.1 V0 基线
1. 关键词匹配 + 手工地点库分类。
2. 简单均匀分配地点到各天（现已实现的 round-robin 可作为初稿）。
3. 用户手动再编辑。

### 6.2 V1 优化
1. 向量检索 + 目的权重打分。
2. 地理聚类（K-Means/DBSCAN）→ 减少跨城移动。
3. 时段模板：上午/下午/晚间按类别优先级放置。

### 6.3 V2 智能化
1. LLM 生成补充 notes / 解释理由。
2. 约束求解：用启发式调度 / 简易遗传算法做日内顺序优化。
3. 对用户改动进行“反学习”，更新偏好权重。

### 6.4 V3 高级
1. 实时数据（天气/节假日客流）动态调整。
2. 交通时间估算（调用地图 API）。
3. 多方案生成 + 评分对比（Plan A/B/C）。

---

## 7. 质量评估指标 (KPIs)
| 维度 | 指标 | 说明 |
|------|------|------|
| 可行性 | 冲突率 | 时间/顺序冲突占比 |
| 覆盖度 | 目的标签覆盖率 | 覆盖的用户目的数 / 总目的数 |
| 连贯性 | 多日主题切换平滑度 | 类别熵变化 |
| 满意度 | 用户人工修改率 | 被修改节点 / 总节点 |
| 反馈 | 再生成接受率 | 一次通过比例 |

---

## 8. 用户反馈循环
1. 用户拖拽 / 删除 / 添加地点 → 记录 diff。
2. 建立 preference profile（喜欢的类别/不喜欢的时段）。
3. 再次生成时利用反馈权重调整打分。
4. 可选：显式“调优按钮”→ 让用户选优化方向（更轻松 / 更多美食 / 减少路程）。

---

## 9. 异常与边界处理
| 场景 | 应对策略 |
|------|----------|
| 无地点符合特定目的 | 显示提示 + 提供最相近类别备选 |
| 预算极低 | 自动降级付费项目，标注“预算受限”说明 |
| 天数过短但目的过多 | 优先级裁剪 + 告知未覆盖标签 |
| 用户清空所有地点 | 回到空状态 UI，引导重新生成 |
| 固定节点占满全天容量 | 提示“当天已满，可解锁/改其他天” |

---

## 10. 后续扩展方向
- 住宿与交通模块（住宿点作为日内锚点）。
- 成本估算细分：餐饮/门票/交通/活动预算拆分。
- 实时天气 + 替换建议（雨天 → 室内活动）。
- AI 语义对话直接修改结构（“把第三天上午换成博物馆”）。
- 生成“行程说明书”PDF / 分享链接。

---

## 11. 简明总结
起点（旅行信息表）= 约束 + 偏好 + 背景。
管道 = 清洗 → 标签/向量 → 候选 → 打分 → 选点 → 排序与修正 → 输出行程表。
终点（行程表）= 可编辑、可解释、可再生成的结构化计划，是后续智能优化与个性化学习的舞台。

> 下一步建议：实现 V1 的“目的权重打分 + 简单地理聚合 + 时段模板”，在现有前端的渲染/拖拽框架上逐步替换数据生成逻辑。

