# 分阶段规划

## 核心设计理念

### 产品核心理念

- 🎯 **景点规划是最基础的功能，也是最核心的需求**
- 🏛️ **没有景点规划不能算旅游规划产品**
- 🤝 **Human in the Loop**：始终保持人在决策环节中的主导地位
- 📊 **分阶段规划**：将复杂的旅游规划分解为可管理的阶段
- 🔄 **多次迭代旅游规划**：支持反复优化和调整，而非一次性完成
- 💬 **用户和大模型双向互动**：AI协助人类决策，人类引导AI优化

### 交互设计原则

- **旅游规划需要反复调整、优化，不可能一次完成**
- **人跟AI要双向互动（Interactive）**
- **AI能修改人的方案，人也能修改AI的方案**
- **需要一个AI和人能够直接操作的工具作为沟通桥梁**（我们已经实现行程表，用来跟大模型直接交互）

## 当前状态 vs 目标设计

### 目前状态
大模型直接生成完整的攻略（景点、酒店、美食）

### 目标设计
1. **先协助用户规划完需要参观的景点**
2. **酒店、美食再根据用户需求进行推荐**
3. 
## 参考模式：编程智能体的to-do列表

| Cursor  | 我们的产品设计 |
|---------------------|----------------|
| 面对复杂的问题，生成一个to-do<br>每个任务都是解决问题的步骤 | 给用户的旅游规划分为：<br>1、确定景点<br>2、确定酒店<br>3、确定餐厅 |
| 每完成一个任务后自动进行下一个任务 | 完成一个任务后，停下来询问用户的意见<br>（可以借助行程表） |

## 分阶段规划的流程

### 总体流程图
```
用户输入需求
    ↓
【第一阶段】景点规划
    ↓
用户确认景点方案
    ↓
【第二阶段】酒店推荐（可选）
    ↓
用户确认酒店方案
    ↓
【第三阶段】餐厅推荐
    ↓
完整方案确定
```

### 详细流程说明

#### 阶段0：需求收集与长期记忆建立
- **长期记忆存储（L1）**：
  - 直接存储用户发送的旅行信息表原始文本
  - 无格式转换，保持用户原始表达的自然性
  - 包含：目的地、旅行日期、出行人数、预算、旅行目的、旅游偏好等
  - 作为后续所有阶段的约束基线和指导原则

- **数据预处理和分析**：
  - 解析长期记忆中的用户偏好标签
  - 分析旅行目的优先级（亲子游、演唱会、度假等）
  - 确定各阶段的推荐范围和权重
  - 建立短期记忆（行程表）的初始结构

- **记忆机制启动**：
  - 长期记忆：用户需求文本（持久保留）
  - 短期记忆：空行程表结构（待填充）
  - 临时上下文：开始记录交互过程
  - 无需额外交互，直接进入景点规划阶段

#### 阶段1：景点规划（必须完成）
1. **AI生成景点方案**
   - 基于长期记忆（用户需求）生成初始景点列表
   - 安排合理的时间和路线
   - 更新短期记忆（行程表JSON结构）
   - 记录推理过程到临时上下文

2. **用户交互确认**
   - 用户查看短期记忆中的景点安排
   - 通过行程表界面增加、删除、修改景点
   - 调整时间安排和顺序
   - 每次修改实时更新短期记忆

3. **方案优化迭代**
   - AI基于长期记忆约束重新优化路线
   - 多轮对话过程记录在临时上下文
   - 最终景点方案固化到短期记忆
   - 必要时触发上下文裁剪（保留长期+短期记忆+最新消息）
   - 用户确认后进入下一阶段

#### 阶段2：酒店推荐（看用户需求）
1. **基于行程推荐酒店**
   - 根据每日行程推荐合适位置的酒店
   - 考虑预算和住宿偏好
   - 优化整体出行便利性

2. **用户交互确认**
   - 用户查看酒店推荐
   - 可以替换不满意的酒店
   - 可以调整住宿安排

3. **方案优化**
   - 确保酒店位置与行程的便利性
   - 优化整体住宿安排

#### 阶段3：餐厅推荐（看用户需求）
1. **基于景点推荐餐厅**
   - 根据景点位置推荐附近餐厅
   - 考虑时间安排（早餐、午餐、晚餐）
   - 结合用户饮食偏好和预算

2. **用户最终确认**
   - 查看完整的旅游方案
   - 做最后的调整
   - 确认完整方案

### 流程控制要点与记忆管理
- **强制停顿**：每个阶段完成后必须等待用户反馈
- **记忆状态保存**：
  - 长期记忆：始终保持用户原始需求文本
  - 短期记忆：每个阶段结果实时更新到行程表
  - 版本快照：关键节点保存长期+短期记忆状态
- **可回退机制**：
  - 基于记忆快照恢复到前一阶段状态
  - 短期记忆回滚，长期记忆保持不变
  - 临时上下文重新开始
- **上下文管理**：
  - 对话过长时自动裁剪临时上下文
  - 保留核心：{长期记忆 + 短期记忆 + 用户最新消息}
  - 确保记忆机制支持长时间多轮对话
- **增量优化**：后续阶段基于短期记忆中已确定的结果，在长期记忆约束下进行推荐



## 交互流程设计

### 核心交互模式（基于三层记忆架构）
```
0. 长期记忆建立 → 读取旅行信息表原始文本 → 存储为L1长期记忆 → 初始化L2短期记忆
1. 景点规划阶段 → AI基于L1生成方案 → 更新L2行程表 → 用户确认/修改L2 → 多轮优化L2
2. 酒店推荐阶段 → AI基于L1+L2推荐 → 更新L2酒店信息 → 用户确认/修改 → 酒店方案确定  
3. 餐厅推荐阶段 → AI基于L1+L2推荐 → 更新L2餐厅信息 → 用户确认/修改 → 完整方案确定
```

### 记忆层级在各阶段的作用
- **L1（长期记忆）**：始终作为约束基线，指导每个阶段的AI推荐逻辑
- **L2（短期记忆）**：承载分阶段累积的规划结果，支持用户直接操作
- **L3（临时上下文）**：记录推理过程和用户反馈，必要时被裁剪

### 上下文管理策略
- **正常对话**：L1 + L2 + L3（完整对话历史）
- **上下文过长时**：触发三元素保留策略
  - 保留：{长期记忆(旅行信息表) + 短期记忆(完整行程表) + 用户最后一条消息}
  - 丢弃：中间对话历史、解释性内容、推理过程
- **跨阶段状态**：L1永久保留，L2随阶段演化，L3可重置

### 各阶段的记忆状态与停顿点
- **阶段0完成后**：
  - 记忆状态：L1已建立（用户原始需求文本），L2已初始化（空行程表结构）
  - 无需停顿：直接进入景点规划，L1作为约束基线指导AI生成
  
- **完成景点规划后**：
  - 记忆状态：L2已填充景点信息，L3记录交互过程
  - 强制停顿：等待用户通过L2（行程表）确认景点方案
  - 状态保存：创建L1+L2快照，支持回退
  - 上下文管理：必要时裁剪L3，保留核心记忆
  
- **完成酒店推荐后**：
  - 记忆状态：L2扩展包含酒店信息，基于L1约束推荐
  - 可选停顿：根据用户需求决定是否执行此阶段
  - 状态同步：酒店选择影响L2中的行程时间安排
  
- **完成餐厅推荐后**：
  - 记忆状态：L2完整包含景点+酒店+餐厅的完整规划
  - 最终确认：L1（用户需求）+ L2（完整方案）的一致性检查
  - 会话总结：可导出L1+L2作为最终交付成果

### 阶段执行策略
- **阶段1（景点规划）**：必须完成，核心功能
- **阶段2（酒店推荐）**：看用户需求，可选执行
- **阶段3（餐厅推荐）**：看用户需求，可选执行

### 用户反馈机制
- **多轮对话优化**：每个阶段都支持用户反复修改直到满意
- **强制用户确认**：每个阶段完成后必须等待用户确认才能继续
- **灵活阶段选择**：用户可以选择跳过酒店或餐厅推荐阶段

### 工具支持与记忆机制
#### 三层记忆架构
- **L1 长期记忆（旅行信息表）**：
  - 作用：旅游规划的起点和约束基线
  - 内容：用户原始文本（目的地、时间、人数、预算、偏好等）
  - 特点：相对稳定，直接存储用户发送的原始文本，无格式转换
  - 生命周期：会话内持久，上下文裁剪时完整保留

- **L2 短期记忆（行程表）**：
  - 作用：当前规划状态的载体，AI和人直接操作的沟通桥梁
  - 内容：结构化的景点、时间、路线安排（JSON格式）
  - 特点：实时更新，支持增删改操作，承载分阶段规划结果
  - 生命周期：会话内演化，上下文裁剪时完整保留

- **L3 临时上下文（对话历史）**：
  - 作用：解释推理过程，阶段间的交互记录
  - 内容：用户与AI的对话消息、解释性内容
  - 特点：变化频繁，可被裁剪
  - 生命周期：上下文裁剪时丢弃，仅保留用户最后一条消息

#### 记忆协同机制
- **版本管理**：长期记忆 + 短期记忆快照，支持方案回退
- **状态保存**：双重记忆的持久化，确保规划状态不丢失
- **增量优化**：长期记忆指导短期记忆演化，后续阶段基于前面确定的结果
- **上下文裁剪**：当对话过长时，保留{长期记忆+短期记忆+最新消息}，丢弃中间对话


## 分阶段实施方案

### 第一阶段：景点规划（核心功能）
**目标**：实现最基础、最核心的景点规划功能

**功能要求**：
- 根据用户输入（目的地、时间、偏好）生成景点推荐
- 支持用户对景点进行增删改
- 生成基本的时间安排和路线规划
- 通过行程表与用户进行交互

**成功标准**：
- 用户能够获得满意的景点安排
- 支持多轮对话优化
- 行程表能够实时更新

### 第二阶段：餐厅推荐（重要补充）
**目标**：基于已确定的景点，推荐合适的餐厅

**功能要求**：
- 基于景点位置推荐附近餐厅
- 考虑用户饮食偏好和预算
- 与景点安排时间匹配（早餐、午餐、晚餐）
- 支持用户调整和替换

**设计考虑**：
- 选饭店比选酒店难很多，需要更细致的推荐逻辑
- 与景点的地理位置和时间安排紧密结合

### 第三阶段：酒店推荐（可选功能）
**目标**：为多日行程提供住宿建议

**功能要求**：
- 基于行程安排推荐合适位置的酒店
- 考虑预算和住宿偏好
- 与整体行程时间匹配

**设计考虑**：
- 相对简单，主要考虑位置和预算
- 可以作为可选功能实现