# MCP工具调用流程说明

## 1. 系统架构

应用使用豆包大模型的 Function Calling 能力来调用 MCP（Map Cloud Platform）工具。整体架构如下：

```
用户 -> Flask应用 -> 豆包大模型 -> MCP工具 -> 格式化结果 -> 用户
```

## 2. 工具定义

系统目前定义了2个核心工具：

1. **获取天气信息**
   ```json
   {
       "name": "获取天气信息",
       "parameters": {
           "city": "城市名或adcode"
       }
   }
   ```

2. **搜索兴趣点**
   ```json
   {
       "name": "搜索兴趣点",
       "parameters": {
           "keywords": "关键词",
           "city": "城市名"
       }
   }
   ```

## 3. 调用流程

1. **用户输入处理**
   - 接收用户的自然语言输入
   - 将用户输入和系统提示词组合成对话历史

2. **大模型推理**
   - 调用豆包大模型进行意图理解
   - 大模型决定是否需要调用工具

3. **工具调用格式**
   ```
   <|FunctionCallBegin|>
   [
   {
       "name": "工具名称",
       "parameters": {
           // 具体参数
       }
   }
   ]
   <|FunctionCallEnd|>
   ```

4. **工具调用处理**
   - 解析大模型的工具调用指令
   - 通过 MCPClientWrapper 执行实际的工具调用
   - 格式化工具返回结果

5. **结果处理**
   - 将工具调用结果作为新的系统消息
   - 再次调用大模型生成最终回复
   - 返回格式化的结果给用户

## 4. 错误处理

1. **参数验证**
   - 检查必要参数是否存在
   - 验证参数格式是否正确

2. **工具调用错误**
   - 捕获并记录工具调用异常
   - 返回友好的错误提示

3. **结果验证**
   - 验证工具返回结果的完整性
   - 处理空结果情况

## 5. 日志记录

系统会记录以下信息：
- 用户输入
- 大模型推理结果
- 工具调用记录
- 错误信息

## 6. 注意事项

1. **工具使用原则**
   - 只在必要时调用工具
   - 优先使用最相关的工具
   - 避免重复调用
   - ⚠️ MCP工具每次调用最多返回20条结果，即使实际匹配结果更多

2. **结果格式化**
   - 使用 Markdown 格式
   - 添加适当的表情符号
   - 保持回复的可读性
   - 当结果被截断时，建议提醒用户"仅展示部分结果"

3. **性能考虑**
   - 避免不必要的工具调用
   - 合理使用缓存
   - 处理超时情况

## 7. 示例

### 天气查询示例
```json
用户输入：海口今天天气怎么样？

工具调用：
<|FunctionCallBegin|>
[
{
    "name": "获取天气信息",
    "parameters": {
        "city": "海口"
    }
}
]
<|FunctionCallEnd|>
```

### 地点搜索示例
```json
用户输入：海甸岛有什么豪华酒店？

工具调用：
<|FunctionCallBegin|>
[
{
    "name": "搜索兴趣点",
    "parameters": {
        "keywords": "海甸岛豪华酒店",
        "city": "海口"
    }
}
]
<|FunctionCallEnd|>
```

### MCP工具实际调用示例
```json
请求：
{
  "method": "tools/call",
  "params": {
    "name": "text_search",
    "arguments": {
      "keywords": "五公祠",
      "city": "海口"
    }
  }
}

响应：
{
  "count": "52",
  "infocode": "10000",
  "pois": [
    {
      "parent": [],
      "address": "海府路169号五公祠内",
      "distance": [],
      "pname": "海南省",
      "importance": [],
      "biz_ext": {
        "cost": "17.00",
        "opentime2": "周一至周日 08:00-23:00",
        "level": "AAA",
        "rating": "4.4",
        "open_time": "08:00-23:00",
        "ticket_ordering": "0"
      },
      "biz_type": "tour",
      "cityname": "海口市",
      "type": "风景名胜;风景名胜;国家级景点",
      "photos": [
        {
          "provider": [],
          "title": [],
          "url": "http://store.is.autonavi.com/showpic/f374c4c055cdacbff085feecddc84736"
        },
        {
          "provider": [],
          "title": [],
          "url": "http://store.is.autonavi.com/showpic/67b2786cb2b72c3069a141ca015d1570"
        },
        {
          "provider": [],
          "title": "苏公祠",
          "url": "http://store.is.autonavi.com/showpic/2504d0c422e9b1752b8c70c657bc8734"
        }
      ],
      "typecode": "110202",
      "shopinfo": "2",
      "poiweight": [],
      "childtype": [],
      "adname": "琼山区",
      "name": "海口五公祠",
      "location": "110.359595,20.007686",
      "tel": "18976265218",
      "shopid": [],
      "id": "B038200FEA"
    }
    // ... 更多POI信息
  ]
}
```

这个示例展示了使用 `text_search` 工具搜索海口五公祠的完整过程，包括：
1. 请求格式：包含方法名、工具名和必要参数
2. 响应格式：包含搜索结果数量和详细的POI信息
3. POI信息：包含名称、地址、经纬度、电话、类型、营业时间等关键信息

### POI 返回字段说明

#### 基础信息
- `id`: POI 唯一标识符
- `name`: POI 名称
- `address`: 详细地址
- `location`: 经纬度坐标
- `tel`: 联系电话
- ⚠️ **注意**：
  - 每次搜索最多返回20条POI信息，如需更多结果需要分页查询
  - 🔧 **Token优化**：当搜索结果超过20条时，系统会自动只保留前10条最相关的结果，以节省token消耗

### 不同类型POI的返回特点

#### 1. 景点类POI（以五公祠为例）
- **基础属性**：
  - 类型标识：风景名胜;风景名胜;国家级景点
  - 景区等级：AAA级
  - 票价信息：17.00元
  - 开放时间：08:00-23:00

- **层级关系**：
  - 主景点（parent为空）
  - 子景点（parent指向主景点ID）
  - 配套设施（停车场、公交站等）

#### 2. 餐饮类POI（以麦当劳为例）
- **基础属性**：
  - 类型标识：餐饮服务;快餐厅;麦当劳
  - 价格区间：15.00-42.00元
  - 营业时间：多样化（24小时/早7点-晚11点等）

- **位置特征**：
  - 商场店铺（购物中心内）
  - 街边门店
  - 商业区店铺

- **扩展信息**：
  - 是否支持点餐
  - 商户评分
  - 照片信息

#### 3. 酒店类POI（以汉庭酒店为例）
- **基础属性**：
  - 类型标识：住宿服务;宾馆酒店;经济型连锁酒店
  - 评分：4.2-4.9不等
  - 预订状态：hotel_ordering（1表示可预订）

- **位置分布**：
  - 商圈店（如国贸中心店）
  - 景区店（如骑楼老街店）
  - 交通枢纽店（如东站店）
  - 地标店（如省政府店）

- **扩展信息**：
  - 房型照片（大床房、双床房、家庭房等）
  - 酒店设施
  - 最低价格（lowest_price）
  - 星级信息（star）

- **特色功能**：
  - 部分店铺设有专门的大堂服务区
  - 提供详细的位置描述（如"东湖天桥旁"）
  - 多个联系电话（前台电话和预订电话）

#### 地理位置信息
- `pname`: 省份名称
- `cityname`: 城市名称
- `adname`: 区域名称
- `distance`: 距离信息

#### 分类信息
- `type`: POI类型描述（如"风景名胜;风景名胜;国家级景点"）
- `typecode`: POI类型代码
- `biz_type`: 业务类型

#### 营业信息
- `biz_ext`: 扩展业务信息
  - `cost`: 票价
  - `open_time`: 开放时间
  - `opentime2`: 详细开放时间
  - `level`: 景区等级
  - `rating`: 评分
  - `ticket_ordering`: 订票服务状态

#### 图片信息
- `photos`: 图片数组
  - `url`: 图片链接
  - `title`: 图片标题
  - `provider`: 图片提供者

#### 关联信息
- `parent`: 父POI信息
- `childtype`: 子POI类型
- `shopid`: 商户ID
- `shopinfo`: 商户信息

# 工具调用说明

## 附近搜索工具

用于搜索指定坐标点附近的地点。

### 调用格式

```json
{
    "name": "附近搜索",
    "parameters": {
        "location": "110.312589,20.055793",  // 经纬度，必填，格式为"经度,纬度"
        "keywords": "酒店",  // 搜索关键词，必填
        "types": "",  // POI类型，必填，可以为空字符串
        "radius": 1000  // 搜索半径，必填，单位：米
    }
}
```

### 参数说明

1. `location`：必填
   - 格式：`"经度,纬度"`
   - 示例：`"110.312589,20.055793"`
   - 注意：经纬度之间用英文逗号分隔，不要带空格

2. `keywords`：必填
   - 搜索关键词
   - 示例：`"酒店"`、`"餐厅"`、`"景点"`等

3. `types`：必填
   - POI类型代码
   - 可以为空字符串`""`
   - 示例：`""`、`"hotel"`、`"restaurant"`等

4. `radius`：必填
   - 搜索半径
   - 单位：米
   - 示例：`1000`（表示1公里）
   - 默认值：1000

### 调用示例

```json
{
    "name": "附近搜索",
    "parameters": {
        "location": "110.312589,20.055793",
        "keywords": "酒店",
        "types": "",
        "radius": 1000
    }
}
```

### 注意事项

1. 参数必须按照顺序提供：location -> keywords -> types -> radius
2. location 参数不要带双引号
3. types 参数即使为空也必须传入空字符串
4. radius 参数可以是数字或字符串类型

### 返回结果

返回高德地图 API 的 JSON 响应，包含搜索到的 POI 信息。如果搜索失败或没有结果，会返回相应的错误信息。

### 错误处理

1. 如果参数格式不正确，会返回格式错误提示
2. 如果经纬度格式不正确，会返回经纬度错误提示
3. 如果在指定范围内未找到符合条件的地点，会返回相应提示
