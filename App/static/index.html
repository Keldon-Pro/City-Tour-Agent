<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">旅游助手首页</title>
    <!-- 预加载标题脚本 -->
    <script>
        // 从服务器获取城市信息设置标题
        (function() {
            try {
                fetch('/api/config/city')
                    .then(response => response.json())
                    .then(data => {
                        if (data.name) {
                            document.title = `${data.name}旅游助手首页`;
                            // 更新主标题
                            document.addEventListener('DOMContentLoaded', function() {
                                const mainTitle = document.getElementById('main-title');
                                if (mainTitle) {
                                    mainTitle.textContent = `${data.name}旅游智能助手`;
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.warn('获取城市配置失败，使用默认标题');
                    });
            } catch (error) {
                // 静默处理
            }
        })();
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- 添加 marked.js 库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* 左边旅客信息栏 */
        #left-column {
            position: fixed;
            left: 26px;
            top: 70px;
            width: 400px;
            height: calc(100vh - 90px);
            background-color: #fff;
            border-radius: 10px 10px 10px 10px !important;
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        /* 折叠按钮样式优化 */
        #collapse-btn {
            position: fixed;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            background-color: #f0f0f0;
            border: none;
            width: 20px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
            transition: all 0.3s ease;
            z-index: 1002;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
        }

        #collapse-btn:hover {
            background-color: #e0e0e0;
            box-shadow: 3px 0 6px rgba(0, 0, 0, 0.15);
        }

        #collapse-btn i {
            font-size: 16px;
            color: #666;
            transition: transform 0.3s ease;
        }

        /* 左栏折叠状态优化 */
        #left-column.collapsed {
            left: -426px;
            overflow: hidden;
        }

        #left-content {
            width: 100%;
            height: 100%;
            opacity: 1;
            transition: opacity 0.3s ease;
            padding: 30px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #left-column.collapsed #left-content {
            opacity: 0;
            pointer-events: none;
        }

        /* 表单样式 */
        form {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-top: 10px;
            font-size: 14px;
            color: #333;
        }

        input,
        select {
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        /* 右边LLM助手栏 */
        #right-column {
            position: fixed;
            right: 20px;
            top: 70px;
            width: calc(100vw - 480px);
            height: calc(100vh - 90px);
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 10px 10px 10px 10px !important;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #right-column.expanded {
            left: 26px;
            right: 20px;
            width: auto;
        }

        /* 聊天窗口样式优化 */
        #chat-window {
            flex: 1;
            overflow-y: auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 消息气泡基础样式优化 */
        .message {
            max-width: 100%;
            padding: 16px 20px;
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 15px;
            position: relative;
            white-space: pre-wrap !important;
            word-wrap: break-word;
        }

        /* 用户消息样式优化 */
        .user-message {
            background-color: #e3f2fd;
            color: #1a237e;
            margin-left: auto;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 20px;
        }

        /* 助手消息样式优化 */
        .assistant-message {
            background: none;
            color: #2c3e50;
            margin-right: 0;
            border-radius: 0;
            padding: 20px 40px 20px 40px;
            box-shadow: none;
            border: none;
            width: 100%;
            max-width: 100%;
            position: static;
            font-size: 20px;
        }

        /* 去除气泡尾巴 */
        .assistant-message::before {
            display: none;
        }

        /* 更紧凑的助手消息样式 */
        .assistant-message p {
            margin: 4px 0 !important;
            line-height: 1.4;
        }

        .assistant-message ul,
        .assistant-message ol {
            margin: 4px 0 !important;
            padding-left: 20px;
        }

        .assistant-message li {
            margin: 2px 0 !important;
            line-height: 1.4;
        }

        .assistant-message h1,
        .assistant-message h2,
        .assistant-message h3 {
            margin-top: 10px !important;
            margin-bottom: 4px !important;
        }

        .assistant-message h1:first-child,
        .assistant-message h2:first-child,
        .assistant-message h3:first-child {
            margin-top: 0 !important;
        }

        /* 优化引用块样式 */
        .assistant-message blockquote {
            margin: 20px 0;
            padding: 12px 24px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            color: #34495e;
            font-size: 0.95em;
            line-height: 1.7;
        }

        /* 优化代码块样式 */
        .assistant-message pre {
            margin: 20px 0;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e8eaed;
        }

        .assistant-message code {
            font-size: 0.9em;
            padding: 3px 6px;
            background: #f1f3f5;
            border-radius: 4px;
            color: #476582;
        }

        /* 优化表格样式 */
        .assistant-message table {
            margin: 20px 0;
            font-size: 0.95em;
        }

        .assistant-message th,
        .assistant-message td {
            padding: 12px 16px;
        }

        /* 优化链接样式 */
        .assistant-message a {
            color: #2196f3;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .assistant-message a:hover {
            color: #1976d2;
            border-bottom-color: #1976d2;
        }

        /* 强调样式 */
        .assistant-message strong {
            color: #2d3748;
            font-weight: 600;
        }

        .assistant-message em {
            color: #4a5568;
            font-style: italic;
        }


        /* 标签样式 */
        .assistant-message .tag {
            display: inline-block;
            background: #f5f5f5;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 8px;
            font-size: 14px;
        }

        /* 输入区域样式优化 */
        .input-container {
            display: flex;
            align-items: flex-end;
            background-color: #fff;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .input-container textarea {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e0e3e9;
            border-radius: 8px;
            font-size: 20px;
            transition: all 0.3s ease;
            resize: none;
            min-height: 72px;
            max-height: 150px;
            line-height: 1.5;
            font-family: inherit;
            height: 72px;
        }

        .input-container textarea:focus {
            outline: none;
            border-color: #4c6ef5;
            box-shadow: 0 0 0 2px rgba(76, 110, 245, 0.1);
        }

        .input-container textarea::placeholder {
            color: #999;
        }

        .input-container button {
            padding: 12px 24px;
            background-color: #4c6ef5;
            color: white;
            border: none;
            border-radius: 8px;
            margin-left: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .input-container button:hover {
            background-color: #4263eb;
            transform: translateY(-1px);
        }

        .input-container button:active {
            transform: translateY(0);
        }

        /* 日期选择器样式优化 */
        .date-range-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            white-space: nowrap;
        }

        .date-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0; /* 防止flex子项溢出 */
        }

        .date-range-container input[type="date"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            flex: 1;
            min-width: 130px;
            font-family: inherit;
        }

        .date-separator {
            color: #666;
            font-size: 14px;
            padding: 0 5px;
            flex-shrink: 0;
        }

        /* 人数选择相关样式 */
        .traveler-section {
            margin: 20px 0;
        }

        .total-travelers {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .total-travelers input {
            width: 80px;
            text-align: center;
        }

        /* 修改左侧竖线样式 */
        .traveler-details {
            margin-left: 20px;
            padding-left: 15px;
            position: relative;
        }

        .traveler-details::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, 
                rgba(224, 224, 224, 0) 0%,
                rgba(224, 224, 224, 0.8) 10%,
                rgba(224, 224, 224, 0.8) 90%,
                rgba(224, 224, 224, 0) 100%);
        }

        .traveler-type {
            margin: 15px 0;
            position: relative;
        }

        .traveler-type-header {
            display: flex;
            align-items: center;
        }

        .traveler-type-header label {
            margin: 0;
            font-size: 15px;
            font-weight: normal;
            white-space: nowrap;
        }

        /* 控件组样式优化 */
        .controls-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        /* 开关按钮容器 */
        .switch-container {
            display: flex;
            align-items: center;
            margin-left: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 30px;
            margin: 0;
            flex-shrink: 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "无";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            text-align: center;
            line-height: 22px;
            font-size: 12px;
            color: #666;
        }

        input:checked + .slider {
            background-color: #4c6ef5;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
            content: "有";
        }

        /* 数字输入组样式 */
        .number-input-group {
            display: none;
        }

        .number-input-group.visible {
            display: block;
        }

        .number-input-group input {
            width: 60px;
            padding: 4px 8px;
            height: 30px;
            margin: 0;
            text-align: center;
        }

        .number-input-group .error-message {
            position: absolute;
            margin-top: 2px;
            font-size: 12px;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        /* 表单分组样式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 10px;
        }

        /* 总人数标签样式 */
        .total-travelers label {
            font-weight: 500;
        }

        /* 旅行目的复选框组样式 */
        .purpose-group {
            margin-top: 10px;
        }

        .purpose-group label {
            font-weight: 500;
            margin-bottom: 15px;
            display: block;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-top: auto;
            vertical-align: middle;
            margin-right: 12px;
            cursor: pointer;
        }

        .checkbox-item span {
            font-size: 14px;
            color: #333;
            user-select: none;
            line-height: 22px;
        }

        /* 其他选项输入框样式优化 */
        .other-purpose-input {
            display: none;
            margin-top: 12px;
            /* 跨越所有列 */
            grid-column: 1 / -1;
            width: 100%;
        }

        .other-purpose-input.visible {
            display: block;
        }

        .other-purpose-input textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
            resize: none;
            font-family: inherit;
            line-height: 1.6;
            height: auto;
        }

        .other-purpose-input textarea:focus {
            outline: none;
            border-color: #4c6ef5;
            box-shadow: 0 0 0 2px rgba(76, 110, 245, 0.1);
        }

        .other-purpose-input textarea::placeholder {
            color: #999;
        }

        /* 旅游偏好样式 */
        .preferences-group {
            margin: 20px 0;
        }
        
        /* 旅游偏好标题的特定间距 */
        .preferences-group .section-label {
            margin-bottom: 18px;
        }

        .preference-item {
            margin-bottom: 16px;
        }

        .preference-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .preference-title i {
            margin-right: 8px;
            color: #4c6ef5;
        }

        .preference-item .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .preference-item .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            width: 100%;
        }

        .preference-item .checkbox-item:hover {
            border-color: #4c6ef5;
            background-color: #f8faff;
            box-shadow: 0 2px 4px rgba(76, 110, 245, 0.1);
        }

        .preference-item .checkbox-item input[type="checkbox"] {
            margin-right: 12px !important;
            vertical-align: middle;
            flex-shrink: 0;
        }

        .preference-item .checkbox-item span {
            vertical-align: middle;
            line-height: 1.4;
            display: flex;
            align-items: center;
        }

        /* 用户输入项复选框行样式 */
        .preference-item .checkbox-item > div {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .preference-item .checkbox-item > div input[type="checkbox"] {
            margin-right: 12px !important;
            vertical-align: middle;
            flex-shrink: 0;
        }

        .preference-item .checkbox-item > div span {
            vertical-align: middle;
            line-height: 1.4;
            display: flex;
            align-items: center;
        }

        .preference-item .checkbox-item input[type="checkbox"]:checked + span,
        .preference-item .checkbox-item > div input[type="checkbox"]:checked + span {
            color: #4c6ef5;
            font-weight: 500;
        }

        /* 特殊需求的其他输入框样式，复用旅行目的的样式 */
        #other-needs-input {
            margin-top: 10px;
        }

        #other-needs-input textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.4;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        #other-needs-input textarea:focus {
            outline: none;
            border-color: #4c6ef5;
            box-shadow: 0 0 0 2px rgba(76, 110, 245, 0.1);
        }

        #other-needs-input textarea::placeholder {
            color: #999;
        }

        /* 旅游偏好自定义输入框样式 */
        .custom-input-container {
            margin-top: 12px;
            margin-left: 0;
            padding-left: 0;
            display: none;
            width: 100%;
        }

        .custom-input, .custom-preference-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #f8f9fa;
        }

        .custom-input:focus, .custom-preference-input:focus {
            outline: none;
            border-color: #4c6ef5;
            box-shadow: 0 0 0 2px rgba(76, 110, 245, 0.1);
            background-color: #ffffff;
        }

        .custom-input::placeholder, .custom-preference-input::placeholder {
            color: #9ca3af;
            font-style: italic;
        }

        /* 预算输入框样式 */
        .budget-group {
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .budget-group label {
            margin: 0;
            font-size: 20px;
            font-weight: 500;
            white-space: nowrap;
        }

        .budget-group input[type="number"] {
            width: 120px;
            height: 32px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 15px;
            text-align: center;
        }

        .budget-group input[type="number"]::-webkit-inner-spin-button {
            opacity: 1;
            background: transparent;
            cursor: pointer;
        }

        .budget-group .error-message {
            color: #dc3545;
            font-size: 12px;
            display: none;
        }

        .budget-group input.error {
            border-color: #dc3545;
        }

        .budget-group input.error + .error-message {
            display: block;
        }

        /* 预算输入组样式 */
        .budget-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 预算说明文字样式 */
        .budget-note {
            font-size: 12px;
            color: #666;
            font-weight: normal;
            white-space: nowrap;
        }

        .budget-label-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        /* 统一各部分标签样式 */
        .section-label {
            font-size: 20px;
            font-weight: 500;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }

        /* 页面主标题样式 */
        .main-title {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 28px;
            font-weight: 500;
            color: #333;
            margin: 0;
            padding: 0;
            background: transparent;
            z-index: 1003;
            height: 60px;
            line-height: 60px;
        }

        .controls-group.child {
            margin-left: 29px;
        }

        .controls-group.young-child {
            margin-left: 17px;
        }

        .controls-group.elderly {
            margin-left: 10px;
        }

        /* 添加提交按钮样式 */
        .submit-button {
            background-color: #4c6ef5;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .submit-button:hover {
            background-color: #4263eb;
            transform: translateY(-1px);
        }

        .submit-button:active {
            transform: translateY(0);
        }

        /* 左侧面板标签样式 */
        .left-panel-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding: 4px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-left: -4px;
            margin-right: -4px;
            padding-left: 8px;
            padding-right: 8px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            color: #6c757d;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
        }

        .tab-btn:hover {
            background: #e9ecef;
            color: #495057;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #4c6ef5 0%, #4263eb 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(76, 110, 245, 0.3);
            transform: translateY(-1px);
        }

        .tab-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 110, 245, 0.4);
        }

        .tab-btn i {
            margin-right: 6px;
            font-size: 16px;
        }

        /* 面板内容样式 */
        .tab-content {
            position: relative;
            min-height: 400px;
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 空状态样式 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #333;
        }

        .empty-state p {
            margin-bottom: 30px;
            color: #666;
        }

        .empty-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }

        .btn-primary, .btn-secondary {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap; /* 禁止按钮内文本换行 */
            width: 240px; /* 统一宽度，纵向对齐更美观 */
            justify-content: center;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }


        /* 添加地点按钮样式 */
        .add-location-section {
            padding: 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            justify-content: center;
            align-items: center;
            background: transparent;
            position: static;
            margin: 20px 0;
        }

        /* 确保 add-location-section 中的按钮也有统一宽度 */
        .add-location-section .btn-secondary {
            width: 240px;
        }

        /* 行程表内容容器 */
        #itinerary-content {
            position: relative;
        }

        #itinerary-days {
            padding-bottom: 20px;
        }

        .btn-add-location {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.25);
            width: 240px;
            justify-content: center;
            letter-spacing: 0.5px;
        }

        .btn-add-location:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004494 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 123, 255, 0.35);
        }

        .btn-add-location:active {
            transform: translateY(0);
            box-shadow: 0 3px 8px rgba(0, 123, 255, 0.3);
        }

        .btn-add-location i {
            font-size: 16px;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        /* 浮动添加按钮 */
        .floating-add-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0, 123, 255, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            opacity: 0;
            transform: scale(0.8) translateY(10px);
        }

        .floating-add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.5);
        }

        .floating-add-btn.show {
            display: flex;
            opacity: 1;
            transform: scale(1) translateY(0);
            animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* 行程表内容样式 */
        .itinerary-day {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .day-header {
            background: linear-gradient(135deg, #4c6ef5 0%, #4263eb 100%);
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .day-number {
            font-size: 16px;
            flex: 1;
            text-align: left;
        }

        .day-date {
            font-size: 16px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .day-count {
            font-size: 14px;
            opacity: 0.9;
            flex: 1;
            text-align: right;
        }

        .location-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
            cursor: move;
            user-select: none;
        }

        .location-item:hover {
            background-color: #f8f9fa;
        }

        .location-item.fixed {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            cursor: default;
        }

        .location-item:last-child {
            border-bottom: none;
        }

        /* 拖拽相关样式 */
        .location-item.dragging {
            opacity: 0.5;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .location-item.drag-over {
            border-top: 3px solid #4c6ef5;
            margin-top: 3px;
        }

        .drag-handle {
            display: none;
        }

        .location-item:hover {
            cursor: move;
            background-color: #f8f9fa !important;
            border-left: 4px solid #007bff !important;
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .location-item:hover .drag-handle {
            display: none;
        }

        .location-item.fixed .drag-handle {
            display: none;
        }

        .visit-order {
            background-color: #e9ecef;
            color: #6f42c1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .location-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 24px; /* 与序号圆圈高度对齐 */
        }

        .location-address {
            font-weight: 500;
            margin-bottom: 0; /* 移除默认间距 */
            line-height: 1.3;
        }

        .location-address:not(:last-child) {
            margin-bottom: 4px; /* 只有当不是最后一个元素时才添加间距 */
        }

        .location-time {
            color: #666;
            font-size: 13px;
            margin-bottom: 2px;
        }

        /* 时间冲突样式 - 简化版 */
        .location-time.time-conflict {
            color: #dc3545; /* 红色 */
            font-weight: 600;
            position: relative;
        }

        .location-time.time-conflict::after {
            content: " ⚠️";
            font-size: 12px;
            margin-left: 4px;
        }

        .location-notes {
            color: #888;
            font-size: 12px;
            font-style: italic;
        }

        .location-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* 按钮显示规则：默认隐藏；悬浮显示；固定项的固定按钮常显 */
        .location-actions .action-btn {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .location-item:hover .location-actions .action-btn {
            opacity: 1;
            pointer-events: auto;
        }
        .location-item.fixed .action-btn.pin-btn {
            opacity: 1;
            pointer-events: auto;
        }

        .action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: #e9ecef;
            color: #333;
        }

        /* Highlight pin toggle button when fixed */
        .action-btn.pin-btn i {
            color: #888;
            transition: color 0.2s ease;
        }
        .action-btn.pin-btn:hover i {
            color: #333;
        }
        .location-item.fixed .action-btn.pin-btn i {
            color: #f59e0b;
        }
        .location-item.fixed .action-btn.pin-btn:hover i {
            color: #d97706; /* amber-600 */
        }

        /* 弹窗样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 0 20px 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group label.checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .form-group label.checkbox-label input[type="checkbox"] {
            margin: 0;
            width: 16px;
            height: 16px;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .help-text {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        /* 暂无安排样式 */
        .no-locations {
            padding: 20px;
            text-align: center;
            color: #999;
            font-style: italic;
            border: 2px dashed transparent;
            border-radius: 8px;
            transition: all 0.3s ease;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .no-locations.drag-over {
            border-color: #4c6ef5;
            background-color: #f8f9ff;
            color: #4c6ef5;
        }


        /* 简化的单层容器样式 */
        .tool-cards-container {
            margin-bottom: 16px;
        }
        
        .tool-card {
            background: #f8fafe;
            margin-bottom: 16px;
            border-radius: 8px;
            border: 1px solid #e8f1ff;
            padding: 12px;
            transition: all 0.2s ease;
        }
        
        .tool-card:hover {
            background: #f0f6ff;
            border-color: #b8d4f1;
        }
        
        .tool-card:last-child {
            margin-bottom: 0;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .tool-icon {
            font-size: 16px;
            width: 18px;
            text-align: center;
        }
        
        .tool-name {
            color: #4c6ef5;
            flex-grow: 1;
        }
        
        .tool-time {
            color: #888;
            font-size: 11px;
            font-weight: 400;
            background: #f0f4f9;
            padding: 1px 6px;
            border-radius: 8px;
        }
        
        .card-toggle {
            cursor: pointer;
            color: #6b7280;
            font-weight: 400;
            margin: 4px 0 8px 0;
            font-size: 12px;
            padding: 3px 6px;
            background: #f5f7fa;
            border-radius: 4px;
            border: 1px solid #e1e5e9;
            transition: all 0.2s ease;
            display: block;
        }
        
        .card-toggle:hover {
            background: #eef2f7;
            color: #4c6ef5;
        }
        
        .card-details[open] .card-toggle {
            background: #e8f2ff;
            color: #4c6ef5;
            border-color: #b8d4f1;
        }
        
        .card-content {
            margin-top: 8px;
        }
        
        .param-block, .result-block {
            margin-bottom: 12px;
        }
        
        .param-block strong, .result-block strong {
            display: block;
            color: #1f2937;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .param-text {
            font-size: 12px;
            color: #374151;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }
        
        .result-text {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            white-space: pre-wrap;
            padding: 8px;
            font-size: 12px;
            line-height: 1.3;
            overflow-x: auto;
            overflow-y: auto;
            margin: 0;
            max-height: 300px;
            min-height: 60px;
            font-family: 'Courier New', monospace;
            word-wrap: break-word;
        }
        
        .result-text::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .result-text::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .result-text::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .result-text::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* 地图浮标按钮样式 */
        #map-float-btn {
            position: fixed;
            top: 80px;
            right: 30px;
            width: 50px;
            height: 50px;
            background-color: #4c6ef5;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(76, 110, 245, 0.3);
            transition: all 0.3s ease;
            z-index: 1003;
        }

        #map-float-btn:hover {
            background-color: #4263eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 110, 245, 0.4);
        }

        #map-float-btn i {
            color: white;
            font-size: 20px;
        }

        /* 地图容器样式 */
        #map-container {
            position: fixed;
            right: 20px;
            top: 70px;
            width: calc(100vw - 480px);
            height: calc(100vh - 90px);
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        /* 当左栏折叠时，地图容器扩展 */
        #left-column.collapsed ~ #map-container {
            left: 26px;
            right: 20px;
            width: auto;
        }

        /* 地图隐藏状态 */
        #map-container.map-hidden {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-20px);
        }

        /* 地图头部 */
        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            background-color: #f8faff;
            border-radius: 10px 10px 0 0;
        }

        .map-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
        }

        .map-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .map-close-btn:hover {
            background-color: #e2e8f0;
        }

        .map-close-btn i {
            color: #64748b;
            font-size: 14px;
        }

        /* 地图iframe样式 */
        .map-iframe {
            flex: 1;
            width: 100%;
            border: none;
            border-radius: 0 0 10px 10px;
        }


    </style>
</head>

<body>
    <h1 class="main-title" id="main-title">旅游智能助手</h1>
    <!-- 主标题会在页面加载时通过预加载脚本更新 -->
    
    <!-- 地图浮标按钮 -->
    <div id="map-float-btn" title="打开/关闭地图">
        <i class="fas fa-map-marked-alt"></i>
    </div>
    
    <!-- 高德地图容器 -->
    <div id="map-container" class="map-hidden">
        <div class="map-header">
            <span class="map-title">高德地图</span>
            <button id="map-close-btn" class="map-close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <iframe src="https://ditu.amap.com/" frameborder="0" class="map-iframe" allow="geolocation *; clipboard-read *; clipboard-write *; fullscreen *; payment *"></iframe>
    </div>
    
    <!-- 折叠按钮 -->
    <div id="collapse-btn">
        <i class="fas fa-chevron-left"></i>
    </div>
    
    <!-- 左边旅程信息栏 -->
    <div id="left-column">
        <div id="left-content">
                <!-- 左侧面板头部标签 -->
                <div class="left-panel-tabs">
                    <button class="tab-btn active" data-tab="travel-info">
                        <i class="fas fa-user-edit"></i> 旅行信息
                    </button>
                    <button class="tab-btn" data-tab="itinerary">
                        <i class="fas fa-route"></i> 行程表
                    </button>
                </div>

                <!-- 面板内容区域 -->
                <div class="tab-content">
                    <div class="tab-pane active" id="travel-info-pane">
                        <!-- 原有的旅程信息表单 -->
            <form>
                    <div class="form-group">
                        <label class="section-label">旅行日期</label>
                        <div class="date-range-container">
                            <div class="date-input-group">
                                <input type="date" id="travel-start-date" required>
                                <span class="date-separator">至</span>
                                <input type="date" id="travel-end-date" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="traveler-section">
                            <div class="total-travelers">
                                <label class="section-label">出行人数</label>
                                <input type="number" 
                                       id="total-travelers" 
                                       value="1" 
                                       min="1" 
                                       placeholder="请输入">
                                <div class="error-message" id="total-error">请输入大于0的整数</div>
                            </div>
                            
                            <div class="traveler-details">
                                <div class="traveler-type">
                                    <div class="traveler-type-header">
                                        <label>儿童（  5岁以下） </label>
                                        <div class="controls-group child">
                                            <label class="switch">
                                                <input type="checkbox" id="child-toggle">
                                                <span class="slider"></span>
                                            </label>
                                            <div class="number-input-group" id="child-input">
                                                <input type="number" 
                                                       id="child-count" 
                                                       value="1" 
                                                       min="1" 
                                                       placeholder="人数">
                                                <div class="error-message">请输入有效人数</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="traveler-type">
                                    <div class="traveler-type-header">
                                        <label>儿童（5岁至12岁）    </label>
                                        <div class="controls-group young-child">
                                            <label class="switch">
                                                <input type="checkbox" id="young-child-toggle">
                                                <span class="slider"></span>
                                            </label>
                                            <div class="number-input-group" id="young-child-input">
                                                <input type="number" 
                                                       id="young-child-count" 
                                                       value="1" 
                                                       min="1" 
                                                       placeholder="人数">
                                                <div class="error-message">请输入有效人数</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="traveler-type">
                                    <div class="traveler-type-header">
                                        <label>老人（60岁及以上）</label>
                                        <div class="controls-group elderly">
                                            <label class="switch">
                                                <input type="checkbox" id="elderly-toggle">
                                                <span class="slider"></span>
                                            </label>
                                            <div class="number-input-group" id="elderly-input">
                                                <input type="number" 
                                                       id="elderly-count" 
                                                       value="1" 
                                                       min="1" 
                                                       placeholder="人数">
                                                <div class="error-message">请输入有效人数</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="budget-group">
                            <label class="section-label" for="travel-budget">预算（元）</label>
                            <div class="budget-input-group">
                                <div>
                                    <input type="number" 
                                           id="travel-budget" 
                                           value="3000" 
                                           min="0" 
                                           step="1000"
                                           required>
                                    <div class="error-message">请输入大于等于0的金额</div>
                                </div>
                                <span class="budget-note">不包括往返路费</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="purpose-group">
                            <label class="section-label">旅行目的</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="travel-purpose" value="休闲度假">
                                    <span>休闲度假</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="travel-purpose" value="亲子游玩">
                                    <span>亲子游玩</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="travel-purpose" value="美食探索">
                                    <span>美食探索</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="travel-purpose" value="文化体验">
                                    <span>文化体验</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="travel-purpose" value="看演唱会">
                                    <span>看演唱会</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="travel-purpose" value="免税购物">
                                    <span>免税购物</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="travel-purpose" value="村落探索">
                                    <span>村落探索</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="travel-purpose" value="露营">
                                    <span>露营</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="travel-purpose" value="赶海">
                                    <span>赶海</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="travel-purpose" value="其他" id="other-purpose-checkbox">
                                    <span>其他</span>
                                </label>
                                <div class="other-purpose-input" id="other-purpose-input">
                                    <textarea 
                                        placeholder="请告诉我们您对旅程的其他重要安排，以便我们为您提供更好的旅行规划！"
                                        id="other-purpose-text"
                                        rows="8"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="preferences-group">
                            <label class="section-label">旅游偏好</label>
                            
                            <!-- 住宿类型 -->
                            <div class="preference-item">
                                <label class="preference-label">住宿类型</label>
                                <div class="checkbox-group" id="accommodation-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="accommodation" value="经济型酒店">
                                        <span>经济型酒店</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="accommodation" value="商务酒店">
                                        <span>商务酒店</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="accommodation" value="度假酒店">
                                        <span>度假酒店</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="accommodation" value="民宿客栈">
                                        <span>民宿客栈</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="accommodation" value="青年旅舍">
                                        <span>青年旅舍</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 餐饮选择 -->
                            <div class="preference-item">
                                <label class="preference-label">餐饮选择</label>
                                <div class="checkbox-group" id="dining-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="dining" value="海南特色菜">
                                        <span>海南特色菜</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="dining" value="海鲜大排档">
                                        <span>海鲜大排档</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="dining" value="火锅烧烤">
                                        <span>火锅烧烤</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="dining" value="快餐简餐">
                                        <span>快餐简餐</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="dining" value="精品餐厅">
                                        <span>精品餐厅</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="dining" value="街边小食">
                                        <span>街边小食</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 出行方式 -->
                            <div class="preference-item">
                                <label class="preference-label">出行方式</label>
                                <div class="checkbox-group" id="transportation-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="transportation" value="公共交通">
                                        <span>公共交通</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="transportation" value="出租车网约车">
                                        <span>出租车网约车</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="transportation" value="自驾租车">
                                        <span>自驾租车</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="transportation" value="共享单车">
                                        <span>共享单车</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="transportation" value="步行">
                                        <span>步行</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 特殊需求 -->
                            <div class="preference-item">
                                <label class="preference-label">特殊需求</label>
                                <div class="checkbox-group" id="special-needs-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="special-needs" value="无障碍设施">
                                        <span>无障碍设施</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="special-needs" value="儿童友好">
                                        <span>儿童友好</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="special-needs" value="老人友好">
                                        <span>老人友好</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="special-needs" value="宠物友好">
                                        <span>宠物友好</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="special-needs" value="其他需求" id="other-needs-checkbox">
                                        <span>其他需求</span>
                                    </label>
                                    <div class="other-purpose-input" id="other-needs-input">
                                        <textarea 
                                            placeholder="请详细描述您的特殊需求，如饮食禁忌、身体状况、特殊偏好等..."
                                            id="other-needs-text"
                                            rows="4"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- 添加提交按钮 -->
                    <button type="button" id="submit-travel-info" class="submit-button">
                        更新旅行信息
                    </button>
            </form>
                    </div>
                    
                    <div class="tab-pane" id="itinerary-pane">
                        <!-- 行程表内容 -->
                        <div id="itinerary-container">
                            <!-- 空状态展示 -->
                            <div id="empty-itinerary" class="empty-state">
                                <div class="empty-icon">
                                    <i class="fas fa-route"></i>
                                </div>
                                <h3>开始制定您的行程</h3>
                                <p>您还没有添加任何行程安排</p>
                                <div class="empty-actions">
                                    <button class="btn-secondary" id="manual-add-btn">
                                        <i class="fas fa-plus"></i> 添加地点
                                    </button>
                                    <button class="btn-secondary" id="import-json-btn" title="从JSON导入行程">
                                        <i class="fas fa-file-import"></i> 导入Json
                                    </button>
                                    <button class="btn-primary" id="ai-generate-btn">
                                        <i class="fas fa-magic"></i> 智能推荐
                                    </button>
                                </div>
                                
                            </div>
                            
                            <!-- 有内容时的行程展示 -->
                            <div id="itinerary-content" style="display: none;">
                                <!-- 动态生成的行程内容 -->
                                <div id="itinerary-days">
                                    <!-- 这里将动态生成每一天的行程 -->
                                </div>
                                
                                <!-- 添加地点按钮 -->
                                <div class="add-location-section">
                                    <button class="btn-secondary" id="import-json-btn-2" title="从JSON导入行程">
                                        <i class="fas fa-file-import"></i> 导入JSON
                                    </button>
                                    <button class="btn-secondary" id="print-itinerary-btn" title="打印行程表">
                                        <i class="fas fa-print"></i> 打印行程表
                                    </button>
                                    <button class="btn-secondary" id="export-json-btn" title="导出行程为JSON格式">
                                        <i class="fas fa-file-export"></i> 导出行程为JSON格式
                                    </button>
                                    <button class="btn-add-location" id="add-location-btn">
                                        <i class="fas fa-plus-circle"></i> 添加新地点
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 添加地点弹窗 -->
                <div id="add-location-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>添加地点</h3>
                            <button class="modal-close" id="close-modal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>选择日期</label>
                                <select id="location-date" class="form-control">
                                    <!-- 动态生成日期选项 -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>地点名称</label>
                                <input type="text" id="location-address" class="form-control" placeholder="请输入地点名称">
                            </div>
                            <div class="form-group">
                                <label>到达时间</label>
                                <input type="time" id="location-time" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>备注信息</label>
                                <textarea id="location-notes" class="form-control" placeholder="可选：添加备注信息"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="location-fixed"> 设为固定行程
                                </label>
                                <small class="help-text">固定行程不可拖拽调整</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" id="cancel-add">取消</button>
                            <button class="btn-primary" id="confirm-add">添加</button>
                        </div>
                    </div>
                </div>

                <!-- 编辑地点弹窗 -->
                <div id="edit-location-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>编辑地点</h3>
                            <button class="modal-close" id="close-edit-modal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>选择日期</label>
                                <select id="edit-location-date" class="form-control">
                                    <!-- 动态生成日期选项 -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>地点名称</label>
                                <input type="text" id="edit-location-address" class="form-control" placeholder="请输入地点名称">
                            </div>
                            <div class="form-group">
                                <label>到达时间</label>
                                <input type="time" id="edit-location-time" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>备注信息</label>
                                <textarea id="edit-location-notes" class="form-control" placeholder="可选：添加备注信息"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="edit-location-fixed"> 设为固定行程
                                </label>
                                <small class="help-text">固定行程不可拖拽调整</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" id="cancel-edit">取消</button>
                            <button class="btn-primary" id="confirm-edit">保存</button>
                        </div>
                    </div>
                </div>

                <!-- 导入JSON弹窗（精简版） -->
                <div id="import-json-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width:700px;">
                        <div class="modal-header">
                            <h3>导入行程JSON</h3>
                            <button class="modal-close" id="close-import-json">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>粘贴行程JSON</label>
                                <textarea id="import-json-text" class="form-control" rows="14" placeholder='{"days": [{"date": "2025-09-16", "day_number": 1, "locations": [...]}]}'></textarea>
                                <small class="help-text">格式请参考示例，导入后将覆盖当前行程。</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" id="load-sample-json">加载示例</button>
                            <div style="flex:1"></div>
                            <button class="btn-primary" id="confirm-import-json">导入</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 导出行程为JSON格式弹窗 -->
    <div id="export-json-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>导出行程为JSON格式</h3>
                <button class="modal-close" id="close-export-json">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>当前行程JSON</label>
                    <textarea id="export-json-text" class="form-control" rows="14" readonly></textarea>
                    <small class="help-text">可复制粘贴到文件中保存，或用于导入到其他设备。</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" id="copy-all-json-btn">一键复制全部</button>
            </div>
        </div>
    </div>
    
    <!-- 右边LLM助手栏 -->
    <div id="right-column">
        <div id="chat-window">
            <div class="message assistant-message">您好！请提供您的旅行信息，我会为您规划行程。</div>
        </div>
        <div class="input-container">
            <textarea 
                placeholder="输入您的问题..." 
                rows="3"
                oninput="this.style.height = '72px'; this.style.height = Math.max(72, this.scrollHeight) + 'px';"
            ></textarea>
            <button>
                <i class="fas fa-paper-plane"></i>
                发送
            </button>
        </div>
    </div>
    
    <!-- 浮动添加地点按钮 -->
    <button class="floating-add-btn" id="floating-add-btn" title="添加新地点">
        <i class="fas fa-plus"></i>
    </button>
    
    <script>
        // 设置日期选择器的默认值和最小值
        const today = new Date();
        const todayString = today.toISOString().split('T')[0];
        
        // 计算三天后的日期
        const threeDaysLater = new Date();
        threeDaysLater.setDate(today.getDate() + 2);
        const threeDaysLaterString = threeDaysLater.toISOString().split('T')[0];
        
        // 设置开始日期和结束日期的默认值和最小值
        const startDateInput = document.getElementById('travel-start-date');
        const endDateInput = document.getElementById('travel-end-date');
        
        startDateInput.min = todayString;
        startDateInput.value = todayString;
        
        endDateInput.min = todayString;
        endDateInput.value = threeDaysLaterString;

        // 当开始日期改变时，设置结束日期的最小值
        startDateInput.addEventListener('change', function() {
            endDateInput.min = this.value;
            if (endDateInput.value < this.value) {
                endDateInput.value = this.value;
            }
            updateDateDisplay();
            updateItineraryDays();
        });

        endDateInput.addEventListener('change', function() {
            updateDateDisplay();
            updateItineraryDays();
        });

        // 行程表相关变量
        let currentPanel = 'travel-info'; // 默认显示旅程信息
        let itineraryData = null; // 存储行程数据
        let editingLocationIndex = null; // 当前编辑的地点索引
        let editingDay = null; // 当前编辑的日期

        // 成功消息提示函数
        function showSuccessMessage(message) {
            // 简单的alert替代，可以后续优化为更好的UI
            alert('✅ ' + message);
        }

        // 错误消息提示函数
        function showErrorMessage(message) {
            // 简单的alert替代，可以后续优化为更好的UI
            alert('❌ ' + message);
        }

        // 标准化行程表数据格式
        function normalizeItineraryPayload(payload) {
            // 仅支持新格式：{days:[]}
            if (!payload || typeof payload !== 'object') return null;
            
            // 检查是否包含 days 数组
            if (Array.isArray(payload.days)) {
                return { days: payload.days };
            }
            
            return null;
        }

        // 确保访问顺序
        function ensureVisitOrders(days) {
            days.forEach(day => {
                if (!Array.isArray(day.locations)) day.locations = [];
                // visit_order 优先保持输入；否则按现有顺序补齐
                day.locations.forEach((loc, idx) => {
                    if (typeof loc.visit_order !== 'number') loc.visit_order = idx + 1;
                    if (!loc.time) loc.time = '';  // 缺省时补齐为空字符串，不是"未设置"
                    if (typeof loc.fixed !== 'boolean') loc.fixed = false;
                    if (!('notes' in loc)) loc.notes = '';
                });
            });
        }

        // 导入行程表函数
        function applyImportedItinerary(payload) {
            const normalized = normalizeItineraryPayload(payload);
            if (!normalized || !Array.isArray(normalized.days)) {
                alert('JSON格式不正确：仅支持 {days:[...]} 格式');
                return;
            }
            // 基本字段校验与补齐
            normalized.days.forEach((day, idx) => {
                if (!day.date) {
                    // 若缺少date，尝试从当前日期区间推断；否则用今天+idx
                    const daysArr = calculateTravelDays();
                    day.date = (daysArr[idx] && daysArr[idx].date) || new Date(Date.now()+idx*86400000).toISOString().split('T')[0];
                }
                if (typeof day.day_number !== 'number') day.day_number = idx + 1;
                if (!Array.isArray(day.locations)) day.locations = [];
            });
            ensureVisitOrders(normalized.days);

            // 替换为导入数据
            itineraryData = {
                days: normalized.days
            };
            
            // 保存到 localStorage 以支持短期记忆功能
            localStorage.setItem('itinerary', JSON.stringify(itineraryData));
            console.log('调试 - 行程数据已保存到localStorage:', itineraryData);
            
            renderItinerary();
            switchPanel('itinerary');
            if (typeof closeImportJsonModal === 'function') {
                closeImportJsonModal();
            }
        }

        // 面板切换函数
        function switchPanel(panelType) {
            const tabs = document.querySelectorAll('.tab-btn');
            const panes = document.querySelectorAll('.tab-pane');
            const leftColumn = document.getElementById('left-column');
            
            // 更新标签状态
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === panelType) {
                    tab.classList.add('active');
                }
            });
            
            // 更新面板显示
            panes.forEach(pane => {
                pane.classList.remove('active');
                if (pane.id === panelType + '-pane') {
                    pane.classList.add('active');
                }
            });
            
            // 平滑滚动到顶部
            if (leftColumn) {
                leftColumn.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }
            
            currentPanel = panelType;
            localStorage.setItem('currentPanel', panelType);
            
            if (panelType === 'itinerary') {
                checkAndShowEmptyState();
                // 延迟更新浮动按钮状态，等待滚动完成
                setTimeout(() => {
                    updateFloatingButtonState();
                }, 400);
            } else {
                // 隐藏浮动按钮
                const floatingBtn = document.getElementById('floating-add-btn');
                if (floatingBtn) {
                    floatingBtn.classList.remove('show');
                }
            }
        }

        // 计算旅行天数并生成日期数组
        function calculateTravelDays() {
            const startDate = document.getElementById('travel-start-date').value;
            const endDate = document.getElementById('travel-end-date').value;
            
            if (!startDate || !endDate) {
                return [];
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = [];
            
            // 生成每一天的日期
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                days.push({
                    date: date.toISOString().split('T')[0], // YYYY-MM-DD格式
                    day_number: days.length + 1,
                    locations: []
                });
            }
            
            return days;
        }

        // 更新日期显示
        function updateDateDisplay() {
            // 保留此函数以备将来需要，但目前不需要更新任何显示
        }

        // 更新行程天数
        function updateItineraryDays() {
            const days = calculateTravelDays();
            
            // 更新行程表数据结构
            if (itineraryData) {
                redistributeLocationsToNewDays(days);
                renderItinerary();
            }
        }

        // 重新分配现有地点到新的天数结构
        function redistributeLocationsToNewDays(newDays) {
            if (!itineraryData || !itineraryData.days) return;
            
            // 收集所有现有地点
            const allLocations = [];
            itineraryData.days.forEach(day => {
                if (day.locations) {
                    allLocations.push(...day.locations);
                }
            });
            
            // 清空新天数的地点
            newDays.forEach(day => {
                day.locations = [];
            });
            
            // 重新分配地点
            if (newDays.length > 0) {
                allLocations.forEach((location, index) => {
                    const dayIndex = index % newDays.length;
                    newDays[dayIndex].locations.push(location);
                });
                
                // 重新分配访问顺序（不进行时间排序）
                newDays.forEach(day => {
                    day.locations.forEach((loc, index) => {
                        loc.visit_order = index + 1;
                    });
                });
            }
            
            // 更新全局数据
            itineraryData.days = newDays;
        }

        // 更新行程表徽章
        function updateItineraryBadge() {
            // 删除了徽章显示功能
        }

        // 渲染行程表
        function renderItinerary() {
            const emptyState = document.getElementById('empty-itinerary');
            const contentState = document.getElementById('itinerary-content');
            const daysContainer = document.getElementById('itinerary-days');
            
            // 检查是否有行程数据
            const hasContent = itineraryData && itineraryData.days && 
                itineraryData.days.some(day => day.locations && day.locations.length > 0);
            
            if (!hasContent) {
                // 显示空状态
                emptyState.style.display = 'block';
                contentState.style.display = 'none';
                // 隐藏浮动按钮
                const floatingBtn = document.getElementById('floating-add-btn');
                if (floatingBtn) {
                    floatingBtn.classList.remove('show');
                }
                return;
            }
            
            // 显示内容状态
            emptyState.style.display = 'none';
            contentState.style.display = 'block';
            
            // 渲染具体内容
            daysContainer.innerHTML = itineraryData.days
                .map(day => renderDaySchedule(day))
                .join('');
                
            // 更新浮动按钮状态
            updateFloatingButtonState();
        }

        // 更新浮动按钮状态
        function updateFloatingButtonState() {
            const floatingBtn = document.getElementById('floating-add-btn');
            const leftColumn = document.getElementById('left-column');
            const itineraryTab = document.querySelector('[data-tab="itinerary"]');
            
            if (!floatingBtn || !leftColumn || !itineraryTab) return;
            
            const isItineraryActive = itineraryTab.classList.contains('active');
            const hasItineraryContent = itineraryData && itineraryData.days && 
                itineraryData.days.some(day => day.locations && day.locations.length > 0);
            const scrollTop = leftColumn.scrollTop;
            
            // 显示条件：在行程表面板 + 有内容 + 滚动超过一定距离
            if (isItineraryActive && hasItineraryContent && scrollTop > 100) {
                floatingBtn.classList.add('show');
            } else if (isItineraryActive && hasItineraryContent && scrollTop <= 100) {
                // 在行程表面板且有内容但没有滚动很多时，延迟显示
                setTimeout(() => {
                    if (leftColumn.scrollTop > 50) {
                        floatingBtn.classList.add('show');
                    }
                }, 300);
            } else {
                floatingBtn.classList.remove('show');
            }
        }

        // 渲染单天行程
        function renderDaySchedule(day) {
            const dateObj = new Date(day.date);
            const weekDays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            const formattedDate = `${dateObj.getMonth() + 1}月${dateObj.getDate()}日 ${weekDays[dateObj.getDay()]}`;
            
            const locationsHtml = day.locations && day.locations.length > 0 
                ? day.locations.map((location, index) => renderLocationItem(location, index, day.date)).join('')
                : `<div class="no-locations" data-date="${day.date}">暂无安排</div>`;
            
            return `
                <div class="itinerary-day" 
                     ondragover="handleDayDragOver(event)" 
                     ondrop="handleDayDrop(event)">
                    <div class="day-header">
                        <div class="day-number">第${day.day_number}天</div>
                        <div class="day-date">${formattedDate}</div>
                        <div class="day-count">${day.locations ? day.locations.length : 0} 个地点</div>
                    </div>
                    ${locationsHtml}
                </div>
            `;
        }

        // 检查时间冲突 - 按时间顺序检查算法
        function checkTimeConflict(currentLocation, index, dayLocations) {
            // 如果当前地点没有时间信息，不检查冲突
            if (!currentLocation.time || currentLocation.time === '') {
                return { hasConflict: false, type: null };
            }
            
            // 获取所有有时间的地点，并按时间排序
            const locationsWithTime = dayLocations
                .map((loc, idx) => ({ ...loc, originalIndex: idx }))
                .filter(loc => loc.time && loc.time !== '');
            
            // 按时间排序
            const sortedByTime = [...locationsWithTime].sort((a, b) => a.time.localeCompare(b.time));
            
            // 找到当前地点在时间排序中的位置
            const currentInSorted = sortedByTime.findIndex(loc => loc.originalIndex === index);
            if (currentInSorted === -1) return { hasConflict: false, type: null };
            
            // 检查当前地点的实际位置是否符合时间顺序
            const currentTimePosition = currentInSorted; // 在时间序列中的位置
            const currentActualPosition = index; // 在实际列表中的位置
            
            // 计算所有有时间地点在实际列表中的位置
            const actualPositions = locationsWithTime.map(loc => loc.originalIndex).sort((a, b) => a - b);
            const currentPositionInActualSequence = actualPositions.indexOf(index);
            
            // 如果时间顺序位置与实际位置不匹配，则有冲突
            if (currentTimePosition !== currentPositionInActualSequence) {
                return { 
                    hasConflict: true, 
                    type: 'order',
                    message: `时间顺序冲突：按时间排序应该是第${currentTimePosition + 1}个，但实际是第${currentPositionInActualSequence + 1}个`
                };
            }
            
            return { hasConflict: false, type: null };
        }

        // 渲染地点项目
        function renderLocationItem(location, index, date) {
            // 获取当天的所有地点来检查时间冲突
            const targetDay = itineraryData.days.find(day => day.date === date);
            const dayLocations = targetDay ? targetDay.locations : [];
            
            // 检查时间冲突
            const conflictResult = checkTimeConflict(location, index, dayLocations);
            
            return `
                <div class="location-item ${location.fixed ? 'fixed' : ''}" 
                     data-date="${date}" 
                     data-index="${index}"
                     draggable="${!location.fixed}"
                     ondragstart="handleDragStart(event)"
                     ondragover="handleDragOver(event)"
                     ondrop="handleDrop(event)"
                     ondragend="handleDragEnd(event)">
                    ${!location.fixed ? '<i class="fas fa-grip-vertical drag-handle"></i>' : ''}
                    <div class="visit-order">${location.visit_order}</div>
                    <div class="location-details">
                        <div class="location-address">${location.address}</div>
                        ${location.time && location.time !== '' ? `<div class="location-time ${conflictResult.hasConflict ? 'time-conflict' : ''}"${conflictResult.hasConflict ? ` title="${conflictResult.message}"` : ''}>${location.time}</div>` : ''}
                        ${location.notes ? `<div class="location-notes">${location.notes}</div>` : ''}
                    </div>
                    
                    <div class="location-actions">
                        <button class="action-btn" onclick="editLocation('${date}', ${index})" title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" onclick="deleteLocation('${date}', ${index})" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="action-btn pin-btn" onclick="toggleFixed('${date}', ${index})" title="${location.fixed ? '取消固定' : '设为固定'}">
                            <i class="fas fa-thumbtack"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // 初始化浮动添加按钮
        function initializeFloatingAddButton() {
            const floatingBtn = document.getElementById('floating-add-btn');
            const leftColumn = document.getElementById('left-column');
            let lastScrollTop = 0;
            
            // 监听左侧面板的滚动
            leftColumn.addEventListener('scroll', function() {
                const scrollTop = leftColumn.scrollTop;
                const scrollHeight = leftColumn.scrollHeight;
                const clientHeight = leftColumn.clientHeight;
                
                // 检查是否在行程表面板
                const itineraryTab = document.querySelector('[data-tab="itinerary"]');
                const isItineraryActive = itineraryTab && itineraryTab.classList.contains('active');
                
                // 检查是否有行程内容
                const hasItineraryContent = itineraryData && itineraryData.days && 
                    itineraryData.days.some(day => day.locations && day.locations.length > 0);
                
                // 显示条件：在行程表面板 + 有内容 + 滚动超过一定距离
                if (isItineraryActive && hasItineraryContent && scrollTop > 100) {
                    floatingBtn.classList.add('show');
                } else {
                    floatingBtn.classList.remove('show');
                }
                
                lastScrollTop = scrollTop;
            });
            
            // 监听面板切换事件
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // 延迟检查，确保面板切换完成
                    setTimeout(() => {
                        const isItineraryActive = this.dataset.tab === 'itinerary';
                        const hasItineraryContent = itineraryData && itineraryData.days && 
                            itineraryData.days.some(day => day.locations && day.locations.length > 0);
                        
                        if (!isItineraryActive || !hasItineraryContent) {
                            floatingBtn.classList.remove('show');
                        }
                    }, 100);
                });
            });
        }

        // 手动添加地点功能
        function initializeManualAdd() {
            const addLocationBtn = document.getElementById('add-location-btn');
            const manualAddBtn = document.getElementById('manual-add-btn');
            const floatingAddBtn = document.getElementById('floating-add-btn');
            const modal = document.getElementById('add-location-modal');
            const closeModal = document.getElementById('close-modal');
            const cancelAdd = document.getElementById('cancel-add');
            const confirmAdd = document.getElementById('confirm-add');
            
            // 绑定打开弹窗事件
            [addLocationBtn, manualAddBtn, floatingAddBtn].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', openAddLocationModal);
                }
            });
            
            // 绑定关闭弹窗事件
            [closeModal, cancelAdd].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', closeAddLocationModal);
                }
            });
            
            // 绑定确认添加事件
            if (confirmAdd) {
                confirmAdd.addEventListener('click', confirmAddLocation);
            }
            
            // 点击遮罩关闭弹窗
            modal?.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeAddLocationModal();
                }
            });
            
            // 添加键盘事件监听
            modal?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    // 如果焦点在备注框（textarea）上，允许换行
                    if (e.target.tagName.toLowerCase() === 'textarea') {
                        return;
                    }
                    e.preventDefault();
                    confirmAddLocation();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closeAddLocationModal();
                }
            });
            
            // 绑定AI推荐按钮
            const aiGenerateBtn = document.getElementById('ai-generate-btn');
            if (aiGenerateBtn) {
                aiGenerateBtn.addEventListener('click', function() {
                    // 第1步：获取完整messageHistory

                    
                    // 第2步：检查对话数量（过滤有效的用户消息）

    
                    // 第3步：开始生成流程

                });
            }

        }


        // 打开添加地点弹窗
        function openAddLocationModal() {
            const modal = document.getElementById('add-location-modal');
            const dateSelect = document.getElementById('location-date');
            
            // 生成日期选项
            const days = calculateTravelDays();
            dateSelect.innerHTML = days.map(day => 
                `<option value="${day.date}">${formatDateDisplay(day.date)} (第${day.day_number}天)</option>`
            ).join('');
            
            // 清空时间字段，让用户自己选择
            const timeInput = document.getElementById('location-time');
            timeInput.value = '';
            
            modal.style.display = 'flex';
        }

        // 关闭添加地点弹窗
        function closeAddLocationModal() {
            const modal = document.getElementById('add-location-modal');
            modal.style.display = 'none';
            
            // 清空表单
            document.getElementById('location-address').value = '';
            document.getElementById('location-notes').value = '';
            document.getElementById('location-fixed').checked = false;
        }

        // 确认添加地点
        function confirmAddLocation() {
            const date = document.getElementById('location-date').value;
            const address = document.getElementById('location-address').value.trim();
            const time = document.getElementById('location-time').value;
            const notes = document.getElementById('location-notes').value.trim();
            const fixed = document.getElementById('location-fixed').checked;
            
            // 验证必填字段
            if (!address) {
                alert('请输入地点名称');
                return;
            }
            
            // 创建新地点对象
            const newLocation = {
                address: address,
                time: time || '', // 如果没有时间，使用空字符串
                notes: notes || '',
                fixed: fixed,
                visit_order: 1 // 临时设置，后面会重新计算
            };
            
            // 添加到行程数据
            addLocationToItinerary(date, newLocation);
            
            // 关闭弹窗
            closeAddLocationModal();
            
            // 重新渲染行程表
            renderItinerary();
        }

        // 添加地点到行程数据
        function addLocationToItinerary(date, location) {
            // 确保有行程数据结构
            if (!itineraryData) {
                const cityName = getCurrentCityName();
                itineraryData = {
                    id: generateId(),
                    title: `我的${cityName}行程`,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    days: calculateTravelDays()
                };
            }
            
            // 找到对应日期的数据
            let targetDay = itineraryData.days.find(day => day.date === date);
            if (!targetDay) {
                // 如果没找到，创建新的一天
                targetDay = {
                    date: date,
                    day_number: itineraryData.days.length + 1,
                    locations: []
                };
                itineraryData.days.push(targetDay);
            }
            
            // 添加地点
            targetDay.locations.push(location);
            
            // 重新分配访问顺序（不进行时间排序）
            targetDay.locations.forEach((loc, index) => {
                loc.visit_order = index + 1;
            });
            
            // 更新时间戳
            itineraryData.updated_at = new Date().toISOString();
        }

        // 编辑地点
        function editLocation(date, index) {
            const targetDay = itineraryData.days.find(day => day.date === date);
            if (!targetDay || !targetDay.locations[index]) {
                return;
            }
            
            const location = targetDay.locations[index];
            editingDay = date;
            editingLocationIndex = index;
            
            const modal = document.getElementById('edit-location-modal');
            const dateSelect = document.getElementById('edit-location-date');
            
            // 生成日期选项
            const days = calculateTravelDays();
            dateSelect.innerHTML = days.map(day => 
                `<option value="${day.date}" ${day.date === date ? 'selected' : ''}>${formatDateDisplay(day.date)} (第${day.day_number}天)</option>`
            ).join('');
            
            // 填充表单
            document.getElementById('edit-location-address').value = location.address;
            document.getElementById('edit-location-time').value = location.time || '';  // 空字符串转换为空值
            document.getElementById('edit-location-notes').value = location.notes || '';
            document.getElementById('edit-location-fixed').checked = location.fixed;
            
            modal.style.display = 'flex';
        }

        // 删除地点
        function deleteLocation(date, index) {
            if (confirm('确定要删除这个地点吗？')) {
                const targetDay = itineraryData.days.find(day => day.date === date);
                if (targetDay && targetDay.locations) {
                    targetDay.locations.splice(index, 1);
                    
                    // 重新分配 visit_order
                    targetDay.locations.forEach((loc, i) => {
                        loc.visit_order = i + 1;
                    });
                    
                    renderItinerary();
                }
            }
        }

        // 切换固定状态
        function toggleFixed(date, index) {
            const targetDay = itineraryData.days.find(day => day.date === date);
            if (targetDay && targetDay.locations[index]) {
                targetDay.locations[index].fixed = !targetDay.locations[index].fixed;
                renderItinerary();
            }
        }

        // 格式化日期显示
        function formatDateDisplay(dateString) {
            const date = new Date(dateString);
            const days = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            return `${date.getMonth() + 1}月${date.getDate()}日 ${days[date.getDay()]}`;
        }

        // 生成唯一ID
        function generateId() {
            return 'itinerary_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 检查并显示空状态
        function checkAndShowEmptyState() {
            if (currentPanel === 'itinerary') {
                renderItinerary();
            }
        }

        // 初始化编辑功能
        function initializeEditFunction() {
            const editModal = document.getElementById('edit-location-modal');
            const closeEditModal = document.getElementById('close-edit-modal');
            const cancelEdit = document.getElementById('cancel-edit');
            const confirmEdit = document.getElementById('confirm-edit');
            
            // 绑定关闭弹窗事件
            [closeEditModal, cancelEdit].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', closeEditLocationModal);
                }
            });
            
            // 绑定确认编辑事件
            if (confirmEdit) {
                confirmEdit.addEventListener('click', confirmEditLocation);
            }
            
            // 点击遮罩关闭弹窗
            editModal?.addEventListener('click', (e) => {
                if (e.target === editModal) {
                    closeEditLocationModal();
                }
            });
            
            // 添加键盘事件监听
            editModal?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    // 如果焦点在备注框（textarea）上，允许换行
                    if (e.target.tagName.toLowerCase() === 'textarea') {
                        return;
                    }
                    e.preventDefault();
                    confirmEditLocation();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closeEditLocationModal();
                }
            });
        }

        // 关闭编辑地点弹窗
        function closeEditLocationModal() {
            const modal = document.getElementById('edit-location-modal');
            modal.style.display = 'none';
            editingDay = null;
            editingLocationIndex = null;
        }

        // 确认编辑地点
        function confirmEditLocation() {
            if (editingDay === null || editingLocationIndex === null) {
                return;
            }
            
            const newDate = document.getElementById('edit-location-date').value;
            const address = document.getElementById('edit-location-address').value.trim();
            const time = document.getElementById('edit-location-time').value;
            const notes = document.getElementById('edit-location-notes').value.trim();
            const fixed = document.getElementById('edit-location-fixed').checked;
            
            // 验证必填字段
            if (!address) {
                alert('请输入地点名称');
                return;
            }
            
            const oldIndex = editingLocationIndex;
            const oldDay = itineraryData.days.find(day => day.date === editingDay);

            if (!oldDay) {
                // 回退：若找不到原天，则不处理
                closeEditLocationModal();
                return;
            }

            if (newDate === editingDay) {
                // 同一天：就地更新，不改变 visit_order
                const loc = oldDay.locations[oldIndex];
                if (loc) {
                    loc.address = address;
                    loc.time = time || '';  // 使用空字符串而不是"未设置"
                    loc.notes = notes || '';
                    loc.fixed = fixed;
                    // 保留原 visit_order
                }
            } else {
                // 跨天：从原天移除，并在新天按规则插入
                const [removed] = oldDay.locations.splice(oldIndex, 1);
                // 重新分配原日期的 visit_order
                oldDay.locations.forEach((loc, i) => { loc.visit_order = i + 1; });

                // 目标天
                let newDayObj = itineraryData.days.find(day => day.date === newDate);
                if (!newDayObj) {
                    newDayObj = { date: newDate, day_number: itineraryData.days.length + 1, locations: [] };
                    itineraryData.days.push(newDayObj);
                }

                // 计算插入位置：
                // - 若存在到达时间，则插入到当天中第一个晚于该时间的地点之前；
                //   若不存在更晚时间，则插在最后一个有时间的地点之后；
                //   若当天无任何时间信息，则插在最后一站。
                // - 若没有到达时间（空字符串），则追加为当天最后一站。
                let insertIndex;
                const hasTime = time && time !== '';
                if (hasTime) {
                    const tNum = (str) => parseInt((str || '').replace(':', '')) || 0;
                    const target = tNum(time);
                    let placed = false;
                    let lastTimedIdx = -1;
                    for (let i = 0; i < newDayObj.locations.length; i++) {
                        const lt = newDayObj.locations[i].time;
                        if (lt && lt !== '') {
                            lastTimedIdx = i;
                            if (tNum(lt) > target) {
                                insertIndex = i;
                                placed = true;
                                break;
                            }
                        }
                    }
                    if (!placed) {
                        insertIndex = lastTimedIdx >= 0 ? lastTimedIdx + 1 : newDayObj.locations.length;
                    }
                } else {
                    insertIndex = newDayObj.locations.length;
                }
                const newLoc = removed || {};
                newLoc.address = address;
                newLoc.time = time || '';  // 使用空字符串而不是"未设置"
                newLoc.notes = notes || '';
                newLoc.fixed = fixed;

                newDayObj.locations.splice(insertIndex, 0, newLoc);
                // 重新分配目标日期的 visit_order
                newDayObj.locations.forEach((loc, i) => { loc.visit_order = i + 1; });
            }

            // 更新时间戳
            itineraryData.updated_at = new Date().toISOString();

            // 关闭弹窗
            closeEditLocationModal();
            
            // 重新渲染行程表
            renderItinerary();
        }

        // 更新折叠按钮逻辑
        const collapseBtn = document.getElementById('collapse-btn');
        const leftColumn = document.getElementById('left-column');
        const rightColumn = document.getElementById('right-column');

        collapseBtn.addEventListener('click', function() {
            leftColumn.classList.toggle('collapsed');
            rightColumn.classList.toggle('expanded');
            
            const icon = collapseBtn.querySelector('i');
            if (leftColumn.classList.contains('collapsed')) {
                icon.classList.remove('fa-chevron-left');
                icon.classList.add('fa-chevron-right');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
            }
        });

        // 人数输入验证
        function validateNumber(input) {
            const value = input.value;
            const errorMessage = input.parentElement.querySelector('.error-message');
            const isValid = /^[1-9]\d*$/.test(value);
            
            if (!isValid) {
                errorMessage.classList.add('visible');
                input.classList.add('error');
                return false;
            }
            
            errorMessage.classList.remove('visible');
            input.classList.remove('error');
            return true;
        }

        // 设置总人数输入验证
        const totalTravelersInput = document.getElementById('total-travelers');
        totalTravelersInput.addEventListener('input', function() {
            validateNumber(this);
        });

        function calculateSpecialGroupTotal() {
            const childCount = document.getElementById('child-toggle').checked ? 
                             (parseInt(document.getElementById('child-count').value) || 0) : 0;
            const youngChildCount = document.getElementById('young-child-toggle').checked ? 
                                  (parseInt(document.getElementById('young-child-count').value) || 0) : 0;
            const elderlyCount = document.getElementById('elderly-toggle').checked ? 
                               (parseInt(document.getElementById('elderly-count').value) || 0) : 0;
            return childCount + youngChildCount + elderlyCount;
        }

        function validateAndLimitSpecialGroups(currentInput, newValue) {
            const totalTravelers = parseInt(totalTravelersInput.value) || 0;
            const currentValue = parseInt(currentInput.value) || 0;
            
            // 计算其他特殊群体的总人数（不包括当前输入）
            const otherGroupsTotal = calculateSpecialGroupTotal() - currentValue;
            
            // 检查新值是否会导致总数超过限制
            if (otherGroupsTotal + newValue > totalTravelers) {
                alert('出行人数必须大于或等于儿童和老人的总人数！');
                return false;
            }
            return true;
        }

        ['elderly', 'young-child', 'child'].forEach(type => {
            const toggle = document.getElementById(`${type}-toggle`);
            const inputGroup = document.getElementById(`${type}-input`);
            const numberInput = document.getElementById(`${type}-count`);

            toggle.addEventListener('change', function() {
                if (this.checked) {
                    inputGroup.classList.add('visible');
                    if (validateAndLimitSpecialGroups(numberInput, 1)) {
                        numberInput.value = '1';
                    } else {
                        this.checked = false;
                        inputGroup.classList.remove('visible');
                    }
                } else {
                    inputGroup.classList.remove('visible');
                }
            });

            numberInput.addEventListener('input', function(e) {
                const newValue = parseInt(this.value) || 0;
                const previousValue = parseInt(this.defaultValue) || 0;

                if (!validateNumber(this) || !validateAndLimitSpecialGroups(this, newValue)) {
                    this.value = previousValue;
                    e.preventDefault();
                } else {
                    this.defaultValue = this.value; // 更新默认值为当前有效值
                }
            });
        });

        // 总人数变化时验证
        totalTravelersInput.addEventListener('input', function() {
            if (validateNumber(this)) {
                const totalTravelers = parseInt(this.value) || 0;
                const specialGroupTotal = calculateSpecialGroupTotal();
                
                if (specialGroupTotal > totalTravelers) {
                    alert('总人数不能小于已设置的儿童和老人人数！');
                    this.value = this.defaultValue;
                } else {
                    this.defaultValue = this.value;
                }
            }
        });

        // 预算输入验证
        const budgetInput = document.getElementById('travel-budget');
        
        budgetInput.addEventListener('input', function() {
            const value = parseFloat(this.value);
            if (isNaN(value) || value < 0) {
                this.classList.add('error');
            } else {
                this.classList.remove('error');
            }
        });

        budgetInput.addEventListener('change', function() {
            const value = parseFloat(this.value);
            if (isNaN(value) || value < 0) {
                this.value = 0;
                this.classList.remove('error');
            }
        });

        // 其他选项的显示/隐藏逻辑
        const otherPurposeCheckbox = document.getElementById('other-purpose-checkbox');
        const otherPurposeInput = document.getElementById('other-purpose-input');
        const otherPurposeText = document.getElementById('other-purpose-text');

        otherPurposeCheckbox.addEventListener('change', function() {
            otherPurposeInput.classList.toggle('visible', this.checked);
            if (this.checked) {
                otherPurposeText.focus();
            }
        });

        // 特殊需求的其他选项显示/隐藏逻辑
        const otherNeedsCheckbox = document.getElementById('other-needs-checkbox');
        const otherNeedsInput = document.getElementById('other-needs-input');
        const otherNeedsText = document.getElementById('other-needs-text');

        otherNeedsCheckbox.addEventListener('change', function() {
            otherNeedsInput.classList.toggle('visible', this.checked);
            if (this.checked) {
                otherNeedsText.focus();
            }
        });

        // 配置 marked.js
        marked.setOptions({
            gfm: true,
            breaks: true,
            headerIds: true,
            mangle: false,
            sanitize: false,
            smartLists: true,
            smartypants: true,
            xhtml: true,
            langPrefix: 'language-',
            pedantic: false,
            highlight: function(code, lang) {
                return code;
            }
        });
        
        // 聊天相关功能
        document.addEventListener('DOMContentLoaded', function() {
            const chatWindow = document.getElementById('chat-window');
            const messageInput = document.querySelector('.input-container textarea');
            const sendButton = document.querySelector('.input-container button');

            // 初始化浮动添加按钮
            initializeFloatingAddButton();

            // 存储对话历史
            let messageHistory = [
                {
                    role: "system",
                    content: `你是一个专业的${getCurrentCityName()}旅游规划助手。请根据用户提供的信息，为用户规划合适的旅游行程。注意考虑预算、时间、人员组成等因素。`
                },
                {
                    role: "assistant",
                    content: "您好！请提供您的旅行信息，我会为您规划行程。"
                }
            ];

    // 辅助函数：判断字符串是否为 JSON
    function isJsonString(str) {
        if (typeof str !== 'string') return false;
        try {
            const obj = JSON.parse(str);
            return typeof obj === 'object';
        } catch (e) {
            return false;
        }
    }
    // 辅助函数：格式化 JSON 字符串
    function formatJsonString(str) {
        try {
            return JSON.stringify(JSON.parse(str), null, 2);
        } catch {
            return str;
        }
    }

    // 辅助函数：格式化为北京时间（Asia/Shanghai）
    function formatBeijingTime(utcString) {
        const date = new Date(utcString);
        return date.toLocaleTimeString('zh-CN', { hour12: false, timeZone: 'Asia/Shanghai' });
    }

    // 辅助函数：从工具调用步骤中提取工具名称
    function extractToolName(step) {
        // 优先使用 tool_name 字段（后端直接提供）
        if (step.tool_name) {
            return step.tool_name;
        }
        
        // 兼容性处理：从content中解析
        const content = step.content;
        if (typeof content === 'object' && content.name) {
            return content.name;
        }
        if (typeof content === 'string') {
            try {
                const parsed = JSON.parse(content);
                if (parsed.name) return parsed.name;
            } catch (e) {
                // 尝试从字符串中提取工具名称
                const match = content.match(/(?:name|tool)["']?\s*:\s*["']([^"']+)["']/i);
                if (match) return match[1];
            }
        }
        return '未知工具';
    }

    // 辅助函数：获取工具名称的中文映射
    function getToolDisplayName(toolName) {
        const toolNameMap = {
            'search_poi': '搜索兴趣点',
            'nearby_search': '附近搜索', 
            'get_weather': '获取天气信息',
            'destination_distance': '目的地距离',
            // 添加其他可能的工具名称
            'search_places': '搜索地点',
            'weather': '天气查询',
            'distance': '距离计算',
            'poi_search': '兴趣点搜索'
        };
        return toolNameMap[toolName] || toolName;
    }

    function renderReasoningSteps(steps) {
        if (!steps || !Array.isArray(steps) || steps.length === 0) return '';
        const filteredSteps = steps.filter(step => step.type === 'tool_call' || step.type === 'tool_result');
        if (filteredSteps.length === 0) return '';
        
        // 只使用一层容器
        let html = '<div class="tool-cards-container">';
        
        let currentToolCallIndex = 0;
        for (let i = 0; i < filteredSteps.length; i++) {
            const step = filteredSteps[i];
            if (
                step.type === 'tool_call' &&
                i + 1 < filteredSteps.length &&
                filteredSteps[i + 1].type === 'tool_result'
            ) {
                const resultStep = filteredSteps[i + 1];
                const toolName = extractToolName(step);
                const displayName = getToolDisplayName(toolName);
                const params = typeof step.content === 'object'
                    ? JSON.stringify(step.content, null, 0)
                    : (isJsonString(step.content)
                        ? formatJsonString(step.content).replace(/\n\s*/g, '')
                        : step.content);
                // 优先显示格式化后的结果
                const result = resultStep.formatted
                    ? resultStep.formatted
                    : (typeof resultStep.content === 'object'
                        ? JSON.stringify(resultStep.content, null, 2)
                        : (isJsonString(resultStep.content)
                            ? formatJsonString(resultStep.content)
                            : resultStep.content));
                currentToolCallIndex++;
                html += '<div class="tool-card" data-tool="' + toolName + '" data-timestamp="' + (step.timestamp || '') + '">' +
                    '<div class="card-header">' +
                        '<span class="tool-icon">🔧</span>' +
                        '<span class="tool-name">第' + currentToolCallIndex + '步：调用[' + displayName + ']工具</span>' +
                        '<span class="tool-time">' + (step.timestamp ? formatBeijingTime(step.timestamp) : '') + '</span>' +
                    '</div>' +
                    '<details class="card-details">' +
                        '<summary class="card-toggle"><i class="fas fa-chevron-down" style="margin-right:6px;"></i>显示调用结果</summary>' +
                        '<div class="card-content">' +
                            '<div class="param-block">' +
                                '<strong>调用参数：</strong>' +
                                '<div class="param-text">' + params + '</div>' +
                            '</div>' +
                            '<div class="result-block">' +
                                '<strong>工具返回：</strong>' +
                                '<pre class="result-text">' + result + '</pre>' +
                            '</div>' +
                        '</div>' +
                    '</details>' +
                '</div>';
                i++;
            }
        }
        html += '</div>';
        return html;
    }

    // Markdown内容预处理，替换2个及以上的连续空行为1个空行
    function cleanMarkdown(md) {
        return typeof md === 'string' ? md.replace(/(\n\s*){2,}/g, '\n\n') : md;
    }

    /**
     * 向聊天窗口添加一条消息。
     * @param {string|object} message - 消息内容。如果是用户消息，为字符串；如果是助手消息，可能为字符串或包含tool_use的对象。
     * @param {boolean} isUser - 是否为用户消息。
     *
     * 功能说明：
     * - 用户消息：直接以文本形式显示。
     *   - 如果包含tool_use（即为对象），先渲染工具调用过程（时间轴），再渲染大模型自然语言回复（支持Markdown）。
     *   - 如果为字符串，直接用marked渲染为Markdown。
     */
    function addMessage(message, isUser = false) {
        const chatWindow = document.getElementById('chat-window');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;
        if (isUser) {
            // 用户消息：直接显示文本
            messageDiv.textContent = message;
        } else {
            // 助手消息
            if (typeof message === 'object' && message.tool_use) {
                // 工具调用卡片 + Markdown回复
                const cleanedResponse = cleanMarkdown(message.response || '');
                messageDiv.innerHTML = renderReasoningSteps(message.tool_use) + marked.parse(cleanedResponse);
            } else {
                // 仅有大模型回复，直接渲染为Markdown
                try {
                    const cleanedMsg = cleanMarkdown(message);
                    const renderedContent = marked.parse(cleanedMsg);
                    messageDiv.innerHTML = renderedContent;
                } catch (error) {
                    messageDiv.textContent = message;
                }
            }
        }
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
   
    /**
     * 从localStorage获取当前行程表数据
     * 
     * @returns {Object|null} 解析后的行程表数据，失败时返回null
     */
    function getCurrentItinerary() {
        console.log('调试 - 开始获取当前行程表数据');
        console.log('调试 - 全局itineraryData:', itineraryData);
        console.log('调试 - itineraryData类型:', typeof itineraryData);
        
        if (itineraryData && itineraryData.days && Array.isArray(itineraryData.days)) {
            console.log('调试 - 找到有效的行程表数据');
            console.log('调试 - 行程天数:', itineraryData.days.length);
            return itineraryData;
        } else {
            console.log('调试 - 没有有效的行程表数据');
            return null;
        }
    }

    /**
     * 获取当前城市名称
     * @returns {string} 城市名称
     */
    function getCurrentCityName() {
        // 首先尝试从页面标题获取
        const pageTitle = document.title;
        if (pageTitle && pageTitle.includes('旅游助手首页')) {
            const cityName = pageTitle.replace('旅游助手首页', '');
            if (cityName && cityName !== '') {
                return cityName;
            }
        }
        
        // 尝试从主标题元素获取
        const mainTitle = document.getElementById('main-title');
        if (mainTitle && mainTitle.textContent) {
            const titleText = mainTitle.textContent;
            if (titleText.includes('旅游智能助手')) {
                const cityName = titleText.replace('旅游智能助手', '');
                if (cityName && cityName !== '') {
                    return cityName;
                }
            }
        }
        
        // 兜底：从当前页面URL或配置推断
        // 如果是在海口项目目录，默认返回海口
        return '海口';
    }

    /**
     * 生成各天的页面内容
     */
    function generateDayPages(itinerary, cityName = '海口') {
        return itinerary.days.map((day, index) => {
            const dayNumber = index + 1;
            const formattedDate = formatDateDisplay(day.date);
            
            return `
        <div class="day-page">
            <div class="day-header">
                <div class="day-title">第${dayNumber}天</div>
                <div class="day-date">${formattedDate}</div>
            </div>
            
            <div class="day-content">
                <ul class="itinerary-list">
                    ${day.locations.map(location => generateLocationItem(location)).join('')}
                </ul>
                
                <!-- 自然留白区域，用户可手写备注 -->
                <div class="whitespace-area"></div>
            </div>
            
            <div class="day-footer">
                ${cityName}旅游行程表 - 第${dayNumber}天 / 共${itinerary.days.length}天
            </div>
        </div>`;
        }).join('');
    }

    /**
     * 生成单个地点项目
     */
    function generateLocationItem(location) {
        return `
        <li class="itinerary-item">
            <div class="time-slot">${location.time || '待定'}</div>
            <div class="activity-info">
                <div class="activity-name">${location.address}</div>
                ${location.notes ? `<div class="activity-notes notes-icon">${location.notes}</div>` : ''}
            </div>
        </li>`;
    }

    /**
     * 生成可打印的行程表
     */
    function generatePrintableItinerary() {
        console.log('🖨️ === generatePrintableItinerary 开始执行 ===');
        
        const itinerary = getCurrentItinerary();
        console.log('获取到的行程数据:', itinerary);
        
        if (!itinerary || !itinerary.days || itinerary.days.length === 0) {
            console.warn('❌ 无行程数据，终止打印');
            alert('暂无行程数据，请先添加行程安排');
            return;
        }
        
        console.log(`✓ 行程数据有效，共 ${itinerary.days.length} 天`);
        
        // 创建新窗口用于打印 - 独立的打印页面
        console.log('创建打印窗口...');
        const printWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
        console.log('打印窗口对象:', printWindow);
        
        if (!printWindow) {
            console.error('❌ 无法创建打印窗口，可能被浏览器阻止');
            alert('无法打开打印窗口，请检查浏览器弹窗拦截设置\n\n' +
                  '解决方法：\n' +
                  '1. 点击地址栏右侧的弹窗阻止图标\n' +
                  '2. 选择"始终允许此网站的弹出式窗口"\n' +
                  '3. 刷新页面后重试');
            return;
        }
        
        // 检测窗口是否真的打开了（某些浏览器会返回窗口对象但实际被阻止）
        setTimeout(() => {
            if (printWindow.closed || !printWindow.document) {
                console.warn('🚫 打印窗口可能被浏览器阻止了');
                alert('检测到打印窗口可能被阻止\n\n' +
                      '请允许此网站的弹窗，然后重试打印功能');
                return;
            } else {
                console.log('✓ 打印窗口正常打开');
            }
        }, 100);
        
        console.log('生成打印HTML内容...');
        const printContent = generatePrintHTML(itinerary);
        console.log('HTML内容长度:', printContent.length, '字符');
        
        console.log('写入打印窗口...');
        printWindow.document.write(printContent);
        printWindow.document.close();
        console.log('✓ 内容写入完成');
        
        // 等待内容加载完成后显示打印提示
        printWindow.onload = function() {
            console.log('📄 打印窗口内容载入完成');
            
            // 尝试让窗口获得焦点
            try {
                printWindow.focus();
                console.log('✓ 窗口已获得焦点');
            } catch (e) {
                console.warn('⚠️ 无法让窗口获得焦点:', e.message);
            }
        };
    }

    // 暴露打印函数到全局作用域，方便控制台调试
    window.generatePrintableItinerary = generatePrintableItinerary;
    window.generatePrintHTML = generatePrintHTML;
    window.generateDayPages = generateDayPages;
    window.generateLocationItem = generateLocationItem;
    window.formatDateDisplay = formatDateDisplay;
    window.getCurrentItinerary = getCurrentItinerary;
    window.getCurrentCityName = getCurrentCityName;
    
    window.debugPrintFunction = function() {
        console.log('=== 打印功能调试信息 ===');
        console.log('1. 检查按钮元素:', document.getElementById('print-itinerary-btn'));
        console.log('2. 检查函数定义:', typeof generatePrintableItinerary);
        console.log('3. 检查 getCurrentItinerary:', typeof getCurrentItinerary);
        console.log('4. 当前行程数据:', getCurrentItinerary());
        console.log('5. 当前城市名称:', getCurrentCityName());
        console.log('6. 检查按钮事件监听器...');
        
        const btn = document.getElementById('print-itinerary-btn');
        if (btn) {
            console.log('   按钮存在，尝试模拟点击...');
            btn.click();
        } else {
            console.log('   ❌ 按钮不存在');
        }
    };
    
    window.testPrintDirectly = function() {
        console.log('=== 直接测试打印功能 ===');
        try {
            generatePrintableItinerary();
        } catch (error) {
            console.error('打印功能出错:', error);
        }
    };

    /**
     * 生成打印用的HTML内容
     */
    function generatePrintHTML(itinerary) {
        console.log('📄 === generatePrintHTML 开始执行 ===');
        console.log('传入的行程数据:', itinerary);
        console.log('行程天数:', itinerary.days ? itinerary.days.length : 0);
        
        // 获取当前城市名称
        const cityName = getCurrentCityName();
        console.log('当前城市名称:', cityName);
        
        const htmlContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${cityName}旅游行程表</title>
    <style>
        /* 打印专用样式 */
        @page {
            size: A4;
            margin: 15mm 12mm;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-print-color-adjust: exact !important;
            color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.6;
            color: #333;
        }
        
        /* 屏幕显示时的提示信息 */
        .print-instructions {
            background: #f8f9fa;
            border: 2px solid #397bb8;
            border-radius: 12px;
            padding: 30px;
            margin: 30px auto;
            max-width: 600px;
            text-align: center;
            color: #2d3748;
            font-size: 14pt;
        }
        
        .print-instructions h2 {
            color: #397bb8;
            margin-bottom: 20px;
            font-size: 18pt;
            font-weight: 700;
        }
        
        .print-instructions ul {
            text-align: left;
            display: inline-block;
            margin: 15px 0;
        }
        
        .print-instructions li {
            margin: 8px 0;
            list-style-type: disc;
        }
        
        .print-btn {
            background: #397bb8;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 8px;
            font-size: 16pt;
            font-weight: 600;
            cursor: pointer;
            margin: 25px auto;
            display: block;
            min-width: 200px;
            text-align: center;
        }
        
        .print-btn:hover {
            background: #2f6a9c;
        }
        
        /* 打印时隐藏说明信息 */
        @media print {
            .print-instructions {
                display: none !important;
            }
        }
        
        /* 每天独占一页 */
        .day-page {
            page-break-before: always;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        .day-page:first-child {
            page-break-before: auto;
        }
        
        /* 页眉设计 */
        .day-header {
            flex: 0 0 auto;
            text-align: center;
            padding: 20px 0 30px 0;
            border-bottom: 2px solid #397bb8;
            margin-bottom: 25px;
        }
        
        .day-title {
            font-size: 18pt;
            font-weight: bold;
            color: #397bb8;
            margin-bottom: 8px;
        }
        
        .day-date {
            font-size: 14pt;
            color: #666;
            font-weight: normal;
        }
        
        /* 行程内容区域 */
        .day-content {
            flex: 1 1 auto;
        }
        
        .itinerary-list {
            list-style: none;
        }
        
        .itinerary-item {
            display: flex;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px dotted #ccc;
            break-inside: avoid;
        }
        
        .itinerary-item:last-child {
            border-bottom: none;
            margin-bottom: 40px;
        }
        
        .time-slot {
            flex: 0 0 120px;
            font-weight: bold;
            color: #397bb8;
            font-size: 12pt;
            margin-right: 15px;
        }
        
        .activity-info {
            flex: 1;
        }
        
        .activity-name {
            font-weight: 600;
            font-size: 12pt;
            margin-bottom: 4px;
            color: #333;
        }
        
        .activity-location {
            font-size: 10pt;
            color: #666;
            margin-bottom: 2px;
        }
        
        .activity-notes {
            font-size: 10pt;
            color: #888;
            font-style: italic;
        }
        
        /* 图标样式 */
        .location-icon::before {
            content: "📍 ";
            margin-right: 4px;
        }
        
        .notes-icon::before {
            content: "💡 ";
            margin-right: 4px;
        }
        
        /* 空白区域标识（仅用于开发调试） */
        .whitespace-area {
            min-height: 100px;
            /* border: 1px dashed #ddd; /* 调试时显示，正式版本移除 */
        }
        
        /* 页脚信息 */
        .day-footer {
            flex: 0 0 auto;
            text-align: center;
            padding-top: 20px;
            margin-top: auto;
            font-size: 9pt;
            color: #aaa;
            border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
    <!-- 打印说明区域 (仅屏幕显示) -->
    <div class="print-instructions">
        <h2>🖨️ ${cityName}旅游行程表 - 打印预览</h2>
        <ul>
            <li>📄 建议使用 A4 纸张打印</li>
            <li>🎨 可选择彩色或黑白打印模式</li>
            <li>📅 每天行程独占一页，避免跨页显示</li>
            <li>✏️ 预留空白区域供手写备注</li>
            <li>📋 可选择"另存为PDF"导出电子版</li>
        </ul>
        <button class="print-btn" onclick="window.print()">🖨️ 开始打印</button>
    </div>
    
    <!-- 行程表内容 -->
    ${generateDayPages(itinerary, cityName)}
</body>
</html>`;
        
        return htmlContent;
    }

    /**
     * 生成各天的页面内容
     */
    function generateDayPages(itinerary, cityName = '海口') {
        return itinerary.days.map((day, index) => {
            const dayNumber = index + 1;
            const formattedDate = formatDateDisplay(day.date);
            
            return `
            <div class="day-page">
                <div class="day-header">
                    <div class="day-title">第${dayNumber}天</div>
                    <div class="day-date">${formattedDate}</div>
                </div>
                
                <div class="day-content">
                    <ul class="itinerary-list">
                        ${day.locations.map(location => generateLocationItem(location)).join('')}
                    </ul>
                    
                    <!-- 自然留白区域，用户可手写备注 -->
                    <div class="whitespace-area"></div>
                </div>
                
                <div class="day-footer">
                    ${cityName}旅游行程表 - 第${dayNumber}天 / 共${itinerary.days.length}天
                </div>
            </div>`;
        }).join('');
    }

    /**
     * 格式化日期显示（用于打印）
     */
    function formatDateDisplay(dateStr) {
        try {
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            const weekday = weekdays[date.getDay()];
            
            return `${year}年${month}月${day}日 ${weekday}`;
        } catch (error) {
            return dateStr;
        }
    }

    /**
     * 处理行程分析响应
     * @param {Object} data - 来自后端的分析响应数据
     */
    function handleItineraryAnalysis(data) {
        console.log('=== 开始处理行程分析响应 ===');
        console.log('响应数据:', data);
        
        try {
            // 显示分析结果消息
            addMessage(data.response, false);
            console.log('✅ addMessage 调用成功');
            
            console.log('=== 行程分析响应处理完成 ===');
            
        } catch (error) {
            console.error('❌ 处理行程分析响应时出错:', error);
            console.error('错误堆栈:', error.stack);
            
            // 错误处理
            if (typeof showErrorMessage === 'function') {
                showErrorMessage('处理分析结果时出现问题：' + error.message);
            }
            
            // 备用：直接显示文本消息
            try {
                addMessage(data.response || '分析结果显示出现问题', false);
            } catch (backupError) {
                console.error('❌ 备用方案也失败:', backupError);
                // 最后的备用方案：直接操作DOM
                const chatWindow = document.getElementById('chat-window');
                if (chatWindow) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message assistant-message';
                    messageDiv.textContent = data.response || '分析结果显示出现问题';
                    chatWindow.appendChild(messageDiv);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }
        }
    }

    /**
     * 向后端发送消息历史，获取大模型回复并处理显示。
     * @param {Array} messages - 当前对话历史（包含system、user、assistant等消息）。
     *
     * 功能说明：
     * - 以POST方式将消息历史发送到后端 /api/chat。
     * - 自动包含当前行程表数据作为短期记忆
     * - 根据后端返回的状态：
     *   - status === 'tool_calling'：显示"正在调用MCP工具..."提示。
     *   - status === 'success' 且有 response：
     *       - 如果有 tool_use，调用 addMessage 渲染工具调用过程和大模型回复。
     *       - 否则只渲染大模型回复。
     *   - 其他情况或异常，显示错误提示。
     * - 每次成功回复后，将assistant回复加入 messageHistory。
     */
    async function sendToBackend(messages) {
        try {
            // 获取当前行程表数据作为短期记忆
            const currentItinerary = getCurrentItinerary();
            console.log('调试 - sendToBackend获取到的currentItinerary:', currentItinerary);
            console.log('调试 - currentItinerary类型:', typeof currentItinerary);
            
            // 加载消息保持默认文本
            
            const requestData = {
                messages,
                current_itinerary: currentItinerary  // 新增参数：当前行程表数据
            };
            console.log('调试 - 准备发送的请求数据:', requestData);
            
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData),
            });
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            // 加载消息保持默认文本
            
            const data = await response.json();
            console.log('Backend response:', data);
            console.log('Response action:', data.action);
            console.log('Response itinerary:', data.itinerary);
            
            if (data.status === 'tool_calling') {
                // 加载消息保持默认文本
                return;
            }
            
            if (data.status === 'success' && data.response) {
                // 检查是否是行程表生成响应
                if (data.action === 'generate_itinerary' && data.itinerary) {
                    // 行程表生成响应
                    try {
                        applyImportedItinerary(data.itinerary);
                        
                        // 显示助手回复
                        addMessage(data.response, false, true); // 第三个参数表示这是行程表消息
                        
                        // 可选：自动切换到行程表面板
                        setTimeout(() => {
                            if (typeof switchToTab === 'function') {
                                switchToTab('itinerary');
                            }
                        }, 2000);
                        
                    } catch (importError) {
                        console.error('行程表导入失败:', importError);
                        // 即使导入失败，也显示助手的回复
                        addMessage(data.response);
                        showErrorMessage('行程表生成成功，但导入时出现问题：' + importError.message);
                    }
                } else if (data.action === 'analyze_itinerary') {
                    // 行程分析响应处理
                    handleItineraryAnalysis(data);
                } else {
                    // 正常的聊天回复
                    if (data.tool_use) {
                        addMessage({ response: data.response, tool_use: data.tool_use });
                    } else {
                        addMessage(data.response);
                    }
                }
                
                // 添加助手回复到历史记录
                messageHistory.push({
                    role: "assistant",
                    content: data.response
                });
            } else if (data.status === 'error') {
                // 处理错误响应
                const errorMessage = data.message || '服务器处理请求时出现错误';
                addMessage(errorMessage, false);
            } else {
                throw new Error('Invalid response format');
            }
        } catch (error) {
            console.error('Error:', error);
            addMessage('抱歉，服务器出现错误，请稍后再试。', false);
            // 确保在错误情况下也隐藏加载状态
            hideLoadingState();
        }
    }

            // 全局变量存储加载消息元素
            let loadingMessageElement = null;

            // 显示加载状态
            function showLoadingState() {
                // 禁用输入和发送按钮
                messageInput.disabled = true;
                sendButton.disabled = true;
                sendButton.classList.add('loading');
                
                // 显示加载消息
                showLoadingMessage();
            }

            // 隐藏加载状态
            function hideLoadingState() {
                // 重新启用输入和发送按钮
                messageInput.disabled = false;
                sendButton.disabled = false;
                sendButton.classList.remove('loading');
                messageInput.focus();
                
                // 隐藏加载消息
                hideLoadingMessage();
            }

            // 显示加载消息
            function showLoadingMessage() {
                if (loadingMessageElement) {
                    // 如果已存在加载消息，先移除
                    hideLoadingMessage();
                }
                
                const chatWindow = document.getElementById('chat-window');
                loadingMessageElement = document.createElement('div');
                loadingMessageElement.className = 'message loading-message';
                loadingMessageElement.innerHTML = `
                    <i class="fas fa-robot loading-icon"></i>
                    <span>助手正在思考，请稍等</span>
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                `;
                
                chatWindow.appendChild(loadingMessageElement);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            // 隐藏加载消息
            function hideLoadingMessage() {
                if (loadingMessageElement) {
                    loadingMessageElement.remove();
                    loadingMessageElement = null;
                }
            }

            // 移除了updateLoadingMessage函数，现在统一使用默认的"助手正在思考，请稍等"提示

            // 发送消息
            async function sendMessage() {
                const message = messageInput.value.trim();
                if (message) {
                    // 添加用户消息到界面
                    addMessage(message, true);
                    
                    // 添加用户消息到历史记录
                    messageHistory.push({
                        role: "user",
                        content: message
                    });

                    // 显示加载状态
                    showLoadingState();
                    
                    // 清空输入框
                    messageInput.value = '';
                    messageInput.style.height = '72px';

                    // 发送消息到后端
                    await sendToBackend(messageHistory);

                    // 隐藏加载状态
                    hideLoadingState();
                }
            }

            // 点击发送按钮发送消息
            sendButton.addEventListener('click', sendMessage);

            // 按Enter键发送消息（Shift+Enter换行）
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // 添加提交旅程信息的处理函数
            const submitButton = document.getElementById('submit-travel-info');
            if (submitButton) {
                submitButton.addEventListener('click', async function() {
                    // 收集表单数据
                    const travelInfo = {
                        dates: {
                            start: document.getElementById('travel-start-date').value,
                            end: document.getElementById('travel-end-date').value
                        },
                        travelers: {
                            total: parseInt(document.getElementById('total-travelers').value) || 0,
                            children_under_5: document.getElementById('child-toggle').checked ? 
                                            (parseInt(document.getElementById('child-count').value) || 0) : 0,
                            children_5_to_12: document.getElementById('young-child-toggle').checked ? 
                                             (parseInt(document.getElementById('young-child-count').value) || 0) : 0,
                            elderly: document.getElementById('elderly-toggle').checked ? 
                                    (parseInt(document.getElementById('elderly-count').value) || 0) : 0
                        },
                        budget: parseInt(document.getElementById('travel-budget').value) || 0,
                        purposes: Array.from(document.querySelectorAll('input[name="travel-purpose"]:checked'))
                                     .map(checkbox => checkbox.value)
                    };

                    // 如果选择了"其他"，添加其他目的的描述
                    if (document.getElementById('other-purpose-checkbox').checked) {
                        const otherPurpose = document.getElementById('other-purpose-text').value;
                        if (otherPurpose.trim()) {
                            travelInfo.otherPurpose = otherPurpose;
                        }
                    }

                    // 动态收集旅游偏好信息
                    const travelPreferences = extractTravelPreferences();

                    // 构建发送给AI助手的消息
                    let message = `我的旅行信息如下：
- 旅行日期：${travelInfo.dates.start} 至 ${travelInfo.dates.end}
- 出行人数：共${travelInfo.travelers.total}人
  * 5岁以下儿童：${travelInfo.travelers.children_under_5}人
  * 5-12岁儿童：${travelInfo.travelers.children_5_to_12}人
  * 60岁以上老人：${travelInfo.travelers.elderly}人
- 旅行预算：${travelInfo.budget}元（不含往返路费）
- 旅行目的：${travelInfo.purposes.join('、')}${travelInfo.otherPurpose ? '\n- 其他安排：' + travelInfo.otherPurpose : ''}`;

                    // 添加旅游偏好信息
                    if (Object.keys(travelPreferences).length > 0) {
                        message += '\n- 旅游偏好：';
                        Object.entries(travelPreferences).forEach(([category, options]) => {
                            message += `\n  * ${category}：${options.join('、')}`;
                        });
                    }

                    message += `\n\n请根据以上信息，为我规划一份详细的${getCurrentCityName()}旅游行程。`;

                    // 添加用户消息到界面
                    addMessage(message, true);
                    
                    // 添加用户消息到历史记录
                    messageHistory.push({
                        role: "user",
                        content: message
                    });
                    
                    // 显示加载状态
                    showLoadingState();
                    
                    // 发送到后端并隐藏加载状态
                    await sendToBackend(messageHistory);
                    hideLoadingState();
                });
            }

            // 动态切换推理卡片折叠/展开图标
            document.getElementById('chat-window').addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('card-toggle')) {
                    const details = e.target.closest('details');
                    setTimeout(() => {
                        const icon = e.target.querySelector('i');
                        if (icon) {
                            if (details.open) {
                                icon.classList.remove('fa-chevron-down');
                                icon.classList.add('fa-chevron-up');
                            } else {
                                icon.classList.remove('fa-chevron-up');
                                icon.classList.add('fa-chevron-down');
                            }
                        }
                    }, 0);
                }
            });
        });
        // 心跳机制，保持后端活跃
        setInterval(() => {
            fetch('/api/heartbeat', { method: 'POST' });
        }, 60000);

        /**
         * 提取旅游偏好信息 - 改进版本
         * 不依赖于ID中的中文，直接从.preference-title元素获取类别名称
         * @returns {Object} 包含所有选中偏好的对象，格式：{类别名: [选项1, 选项2, ...]}
         */
        function extractTravelPreferences() {
            console.log('========== 开始提取旅游偏好信息 ==========');
            
            const travelPreferences = {};
            const preferenceGroups = document.querySelectorAll('.preferences-group .preference-item');
            
            console.log(`找到 ${preferenceGroups.length} 个偏好组:`, preferenceGroups);
            
            if (preferenceGroups.length === 0) {
                console.warn('警告：没有找到任何 .preferences-group .preference-item 元素');
                // 尝试其他可能的选择器
                const alternativeGroups = document.querySelectorAll('.preference-item');
                console.log(`尝试备用选择器，找到 ${alternativeGroups.length} 个 .preference-item 元素:`, alternativeGroups);
                return travelPreferences;
            }
            
            preferenceGroups.forEach((group, groupIndex) => {
                console.log(`\n--- 处理第 ${groupIndex + 1} 个偏好组 ---`);
                console.log('偏好组元素:', group);
                
                // 改进的类别名称获取方式 - 直接从preference-title获取
                let categoryName = null;
                const titleElement = group.querySelector('.preference-title');
                
                console.log('标题元素查找结果:', titleElement);
                
                if (titleElement) {
                    // 直接获取标题的文本内容，并去除图标部分
                    const fullText = titleElement.textContent.trim();
                    console.log('完整标题文本:', fullText);
                    
                    // 智能提取类别名称：跳过图标字符
                    const iconElement = titleElement.querySelector('i');
                    if (iconElement) {
                        console.log('找到图标元素:', iconElement);
                        
                        // 改进的图标文本处理方法
                        // FontAwesome图标通常没有textContent，所以我们用更可靠的方法
                        
                        // 方法1：创建临时克隆，移除图标元素后获取文本
                        const tempTitle = titleElement.cloneNode(true);
                        const tempIcon = tempTitle.querySelector('i');
                        if (tempIcon) {
                            tempIcon.remove();
                        }
                        categoryName = tempTitle.textContent.trim();
                        console.log('通过移除图标元素获取的类别名:', categoryName);
                        
                        // 方法2：如果方法1没有效果，使用文本分割
                        if (!categoryName) {
                            const textParts = fullText.split(/\s+/);
                            if (textParts.length > 1) {
                                // 跳过第一个部分（通常是图标字符），取后面的部分
                                categoryName = textParts.slice(1).join(' ');
                                console.log('通过文本分割获取的类别名:', categoryName);
                            } else {
                                // 如果分割失败，保留完整文本
                                categoryName = fullText;
                                console.log('使用完整文本作为类别名:', categoryName);
                            }
                        }
                    } else {
                        // 没有图标的情况：直接使用文本
                        categoryName = fullText;
                        console.log('没有图标，直接使用文本:', categoryName);
                    }
                    
                    console.log('提取的类别名:', categoryName);
                } else {
                    console.warn('未找到标题元素，尝试其他方式获取类别名');
                    // 备用方案：从group的id获取（但要去除-group后缀）
                    if (group.id && group.id.endsWith('-group')) {
                        categoryName = group.id.replace('-group', '').replace(/^\d+-/, ''); // 去除可能的数字前缀
                        console.log('从ID获取的类别名:', categoryName);
                    }
                }
                
                if (!categoryName) {
                    console.warn('无法获取类别名，跳过此偏好组');
                    return;
                }
                
                console.log(`类别名确定为: "${categoryName}"`);
                
                const selectedOptions = [];
                const checkboxes = group.querySelectorAll('input[type="checkbox"]:checked');
                
                console.log(`在类别 "${categoryName}" 中找到 ${checkboxes.length} 个选中的复选框:`, checkboxes);
                
                checkboxes.forEach((checkbox, checkboxIndex) => {
                    const value = checkbox.value;
                    console.log(`  复选框 ${checkboxIndex + 1}: 值="${value}"`);
                    
                    // 检查是否是自定义输入项
                    const checkboxItem = checkbox.closest('.checkbox-item');
                    console.log('  复选框项容器:', checkboxItem);
                    
                    const customInputContainer = checkboxItem ? checkboxItem.querySelector('.custom-input-container') : null;
                    console.log('  自定义输入容器:', customInputContainer);
                    
                    if (customInputContainer) {
                        const isVisible = customInputContainer.style.display !== 'none';
                        console.log(`  自定义输入容器是否可见: ${isVisible}`);
                        
                        if (isVisible) {
                            const customInput = customInputContainer.querySelector('input[type="text"]');
                            console.log('  自定义输入框:', customInput);
                            
                            if (customInput && customInput.value.trim()) {
                                // 自定义输入项：显示为 "选项名：用户输入内容"
                                const formattedValue = `${value}：${customInput.value.trim()}`;
                                selectedOptions.push(formattedValue);
                                console.log(`  添加自定义选项: "${formattedValue}"`);
                            } else {
                                // 如果自定义输入框为空，只显示选项名
                                selectedOptions.push(value);
                                console.log(`  添加空自定义选项: "${value}"`);
                            }
                        } else {
                            // 普通选项：直接使用选项名
                            selectedOptions.push(value);
                            console.log(`  添加普通选项: "${value}"`);
                        }
                    } else {
                        // 普通选项：直接使用选项名
                        selectedOptions.push(value);
                        console.log(`  添加普通选项: "${value}"`);
                    }
                });
                
                // 只有当有选中项时才添加到结果中
                if (selectedOptions.length > 0) {
                    travelPreferences[categoryName] = selectedOptions;
                    console.log(`类别 "${categoryName}" 最终选项:`, selectedOptions);
                } else {
                    console.log(`类别 "${categoryName}" 没有选中项，跳过`);
                }
            });
            
            console.log('\n========== 提取结果 ==========');
            console.log('最终旅游偏好对象:', travelPreferences);
            console.log('提取的类别数量:', Object.keys(travelPreferences).length);
            console.log('========== 提取完成 ==========\n');
            
            return travelPreferences;
        }

        /**
         * 调试函数：检查页面中的偏好相关元素
         */
        function debugTravelPreferences() {
            console.log('========== 开始调试旅游偏好元素 ==========');
            
            // 检查偏好容器
            const preferencesGroup = document.querySelector('.preferences-group');
            console.log('偏好总容器 (.preferences-group):', preferencesGroup);
            
            // 检查偏好项
            const preferenceItems = document.querySelectorAll('.preference-item');
            console.log(`所有偏好项 (.preference-item): ${preferenceItems.length} 个`, preferenceItems);
            
            // 检查具体的偏好组
            const preferenceGroups = document.querySelectorAll('.preferences-group .preference-item');
            console.log(`偏好组 (.preferences-group .preference-item): ${preferenceGroups.length} 个`, preferenceGroups);
            
            // 检查所有复选框
            const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
            console.log(`所有复选框: ${allCheckboxes.length} 个`, allCheckboxes);
            
            // 检查选中的复选框
            const checkedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            console.log(`选中的复选框: ${checkedCheckboxes.length} 个`, checkedCheckboxes);
            
            // 检查preference-title元素
            const preferenceTitles = document.querySelectorAll('.preference-title');
            console.log(`偏好标题元素: ${preferenceTitles.length} 个`, preferenceTitles);
            preferenceTitles.forEach((title, index) => {
                console.log(`  标题 ${index + 1}: "${title.textContent.trim()}"`);
            });
            
            // 检查自定义输入框
            const customInputs = document.querySelectorAll('.custom-input-container input[type="text"]');
            console.log(`自定义输入框: ${customInputs.length} 个`, customInputs);
            
            // 显示页面HTML结构（偏好部分）
            if (preferencesGroup) {
                console.log('偏好区域HTML结构（前500字符）:');
                console.log(preferencesGroup.outerHTML.substring(0, 500) + '...');
            }
            
            console.log('========== 调试完成 ==========\n');
            
            return {
                preferencesGroup: !!preferencesGroup,
                preferenceItemsCount: preferenceItems.length,
                preferenceGroupsCount: preferenceGroups.length,
                preferenceTitlesCount: preferenceTitles.length,
                allCheckboxesCount: allCheckboxes.length,
                checkedCheckboxesCount: checkedCheckboxes.length,
                customInputsCount: customInputs.length
            };
        }
        
        // 照片翻页功能
        window.changePhoto = function(direction, poiIndex) {
            const container = document.querySelector(`.poi-photo-container[data-poi-index="${poiIndex}"]`);
            if (!container) return;
            
            const photos = container.querySelectorAll('.poi-photo');
            if (photos.length <= 1) return; // 只有一张照片时不需要翻页
            
            // 找到当前显示的照片
            let currentIndex = Array.from(photos).findIndex(photo => 
                window.getComputedStyle(photo).display !== 'none');
            
            // 隐藏当前照片
            photos[currentIndex].style.display = 'none';
            
            // 计算下一个索引
            let nextIndex = currentIndex + direction;
            if (nextIndex >= photos.length) nextIndex = 0;
            if (nextIndex < 0) nextIndex = photos.length - 1;
            
            // 显示下一张照片
            photos[nextIndex].style.display = 'block';
            
            // 更新圆点指示器
            updateDots(container, nextIndex);
        };

        // 更新圆点指示器
        window.updateDots = function(container, activeIndex) {
            const dots = container.querySelectorAll('.poi-photo-dot');
            dots.forEach((dot, index) => {
                if (index === activeIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        };

        // 初始化圆点指示器
        window.initializePhotoContainers = function() {
            console.log('Initializing photo containers - Start');
            const containers = document.querySelectorAll('.poi-photo-container');
            console.log('Found containers:', containers.length);
            containers.forEach(container => {
                // 检查是否已经初始化过
                if (container.classList.contains('initialized')) {
                    console.log('Container already initialized, skipping:', container.dataset.poiIndex);
                    return;
                }
                const photos = container.querySelectorAll('.poi-photo');
                console.log('Container', container.dataset.poiIndex, 'has photos:', photos.length);
                if (photos.length > 1) {
                    console.log('Creating dots for container', container.dataset.poiIndex);
                    const dotsContainer = document.createElement('div');
                    dotsContainer.className = 'poi-photo-dots';
                    for (let i = 0; i < photos.length; i++) {
                        const dot = document.createElement('div');
                        dot.className = 'poi-photo-dot';
                        if (i === 0) dot.classList.add('active');
                        dot.onclick = () => {
                            const currentPhotos = container.querySelectorAll('.poi-photo');
                            currentPhotos.forEach((photo, idx) => {
                                photo.style.display = idx === i ? 'block' : 'none';
                            });
                            updateDots(container, i);
                        };
                        dotsContainer.appendChild(dot);
                    }
                    container.appendChild(dotsContainer);
                    console.log('Dots added to container', container.dataset.poiIndex);
                    
                    // 添加翻页按钮事件监听器
                    const prevButton = container.querySelector('.poi-photo-nav-prev');
                    const nextButton = container.querySelector('.poi-photo-nav-next');
                    const poiIndex = container.dataset.poiIndex;
                    if (prevButton) {
                        prevButton.removeAttribute('onclick');
                        prevButton.addEventListener('click', () => {
                            changePhoto(-1, poiIndex);
                        });
                    }
                    if (nextButton) {
                        nextButton.removeAttribute('onclick');
                        nextButton.addEventListener('click', () => {
                            changePhoto(1, poiIndex);
                        });
                    }
                    console.log('Navigation buttons initialized for container', poiIndex);
                    
                    // 标记为已初始化
                    container.classList.add('initialized');
                    console.log('Container marked as initialized:', container.dataset.poiIndex);
                } else {
                    console.log('Not enough photos to create dots for container', container.dataset.poiIndex);
                }
            });
            console.log('Initializing photo containers - End');
        };

        // 在页面加载完成后初始化照片容器
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded: Initializing photo containers');
            initializePhotoContainers();
        });

        // 使用MutationObserver替代DOMSubtreeModified，确保在聊天消息添加后也初始化照片容器
        const chatWindow = document.getElementById('chat-window');
        const observer = new MutationObserver(function(mutations) {
            const newContainers = document.querySelectorAll('.poi-photo-container:not(.initialized)');
            if (newContainers.length > 0) {
                console.log('MutationObserver: Chat window updated, found new containers:', newContainers.length);
                initializePhotoContainers();
            } else {
                console.log('MutationObserver: Chat window updated, no new containers found');
            }
        });
        observer.observe(chatWindow, { childList: true, subtree: true });

        // 初始化行程表功能
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化页面配置
            initializePageConfig();
            
            // 绑定标签点击事件
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchPanel(btn.dataset.tab);
                });
            });
            
            // 初始化手动添加功能
            initializeManualAdd();
            
            // 初始化编辑功能
            initializeEditFunction();
            
            // 初始化日期显示
            updateDateDisplay();
            
            // 恢复面板状态
            const savedPanel = localStorage.getItem('currentPanel');
            if (savedPanel && document.getElementById(savedPanel + '-pane')) {
                switchPanel(savedPanel);
            }

            // 导入JSON入口绑定（正式功能）
            const importBtn = document.getElementById('import-json-btn');
            const importBtn2 = document.getElementById('import-json-btn-2');
            const importModal = document.getElementById('import-json-modal');
            const importClose = document.getElementById('close-import-json');
            const importConfirm = document.getElementById('confirm-import-json');
            const importTextarea = document.getElementById('import-json-text');
            const loadSampleBtn = document.getElementById('load-sample-json');

            function openImportJsonModal() {
                if (importTextarea) importTextarea.value = '';
                importModal.style.display = 'flex';
            }
            function closeImportJsonModal() {
                importModal.style.display = 'none';
            }
            function normalizeItineraryPayload(payload) {
                // 仅支持新格式：{days:[]}
                if (!payload || typeof payload !== 'object') return null;
                
                // 检查是否包含 days 数组
                if (Array.isArray(payload.days)) {
                    return { days: payload.days };
                }
                
                return null;
            }
            function ensureVisitOrders(days) {
                days.forEach(day => {
                    if (!Array.isArray(day.locations)) day.locations = [];
                    // visit_order 优先保持输入；否则按现有顺序补齐
                    day.locations.forEach((loc, idx) => {
                        if (typeof loc.visit_order !== 'number') loc.visit_order = idx + 1;
                        if (!loc.time) loc.time = '';  // 缺省时补齐为空字符串，不是"未设置"
                        if (typeof loc.fixed !== 'boolean') loc.fixed = false;
                        if (!('notes' in loc)) loc.notes = '';
                    });
                });
            }
            function applyImportedItinerary(payload) {
                const normalized = normalizeItineraryPayload(payload);
                if (!normalized || !Array.isArray(normalized.days)) {
                    alert('JSON格式不正确：仅支持 {days:[...]} 格式');
                    return;
                }
                // 基本字段校验与补齐
                normalized.days.forEach((day, idx) => {
                    if (!day.date) {
                        // 若缺少date，尝试从当前日期区间推断；否则用今天+idx
                        const daysArr = calculateTravelDays();
                        day.date = (daysArr[idx] && daysArr[idx].date) || new Date(Date.now()+idx*86400000).toISOString().split('T')[0];
                    }
                    if (typeof day.day_number !== 'number') day.day_number = idx + 1;
                    if (!Array.isArray(day.locations)) day.locations = [];
                });
                ensureVisitOrders(normalized.days);

                // 替换为导入数据
                itineraryData = {
                    days: normalized.days
                };
                
                renderItinerary();
                switchPanel('itinerary');
                closeImportJsonModal();
            }

            importBtn?.addEventListener('click', openImportJsonModal);
            importBtn2?.addEventListener('click', openImportJsonModal);
            importClose?.addEventListener('click', closeImportJsonModal);
            importConfirm?.addEventListener('click', () => {
                let text = importTextarea?.value || '';
                if (!text.trim()) {
                    alert('请粘贴JSON后再导入');
                    return;
                }
                try {
                    const obj = JSON.parse(text);
                    applyImportedItinerary(obj);
                } catch (e) {
                    alert('JSON解析失败：' + e.message);
                }
            });
            loadSampleBtn?.addEventListener('click', () => {
                // 动态日期：从当天开始
                const fmt = (d) => {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${y}-${m}-${day}`;
                };
                const today = new Date();
                const day2 = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);
                const day3 = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 2);

                // 标准数据格式：{"days": [...]}
                const sample = {
                    days: [
                        {
                            date: fmt(today),
                            day_number: 1,
                            locations: [
                                { address: '海口美兰国际机场', time: '10:30', notes: '到达海口', fixed: true, visit_order: 1 },
                                { address: '海口华彩洲际酒店', time: '12:00', notes: '办理入住，短暂休息', fixed: false, visit_order: 2 },
                                { address: '海口骑楼老街', time: '15:00', notes: '历史文化街区，拍照打卡', fixed: false, visit_order: 3 },
                                { address: '天空之山驿站', time: '18:30', notes: '赏绝美日落~', fixed: false, visit_order: 4 },
                                { address: '海大南门夜市', time: '22:00', notes: '体验最火爆的海口夜市，感受人间烟火！', fixed: false, visit_order: 5 }
                            ]
                        },
                        {
                            date: fmt(day2),
                            day_number: 2,
                            locations: [
                                { address: '海南省博物馆', time: '09:00', notes: '了解海南的历史和文化', fixed: false, visit_order: 1 },
                                { address: '海瑞文化公园', time: '15:00', notes: '', fixed: false, visit_order: 2 },
                                { address: '海口五源河体育场', time: '19:30', notes: '演唱会20:00开始，从A口安检', fixed: false, visit_order: 3 }
                            ]
                        },
                        {
                            date: fmt(day3),
                            day_number: 3,
                            locations: [
                                { address: '海口五公祠', time: '09:30', notes: '', fixed: false, visit_order: 1 },
                                { address: 'cdf海口国际免税城', time: '15:30', notes: '回家之前买点免税品', fixed: false, visit_order: 2 },
                                { address: '海口美兰国际机场', time: '18:00', notes: '晚上8点飞机起飞', fixed: true, visit_order: 3 }
                            ]
                        }
                    ]
                };
                if (importTextarea) {
                    importTextarea.value = JSON.stringify(sample, null, 2);
                }
            });
            
            // 绑定打印行程表按钮事件 - 添加详细调试
            console.log('=== 开始初始化打印功能 ===');
            const printItineraryBtn = document.getElementById('print-itinerary-btn');
            console.log('打印按钮元素:', printItineraryBtn);
            
            if (printItineraryBtn) {
                console.log('✓ 找到打印按钮，开始绑定事件');
                printItineraryBtn.addEventListener('click', function(event) {
                    console.log('🖨️ === 打印按钮被点击 ===');
                    console.log('事件对象:', event);
                    
                    // 阻止默认行为
                    event.preventDefault();
                    event.stopPropagation();
                    
                    try {
                        console.log('准备调用 generatePrintableItinerary()');
                        generatePrintableItinerary();
                        console.log('✓ generatePrintableItinerary() 调用完成');
                    } catch (error) {
                        console.error('❌ 打印功能出错:', error);
                        alert('打印功能出错: ' + error.message);
                    }
                });
                console.log('✓ 打印按钮事件绑定完成');
            } else {
                console.error('❌ 无法找到打印按钮元素 (ID: print-itinerary-btn)');
                
                // 检查页面中所有可能的打印按钮
                const allButtons = document.querySelectorAll('button');
                console.log('页面中所有按钮:', allButtons);
                
                const printButtons = document.querySelectorAll('[id*="print"], [class*="print"]');
                console.log('包含print关键字的元素:', printButtons);
            }
            
            // 添加全局调试函数
            window.debugPrintFeature = function() {
                console.log('=== 打印功能调试信息 ===');
                const btn = document.getElementById('print-itinerary-btn');
                console.log('打印按钮元素:', btn);
                console.log('当前行程数据:', itineraryData);
                console.log('getCurrentItinerary()结果:', getCurrentItinerary());
                
                if (btn) {
                    console.log('手动触发打印功能...');
                    generatePrintableItinerary();
                }
            };
            console.log('✓ 全局调试函数 window.debugPrintFeature() 已创建');

            // 导出JSON入口绑定
            const exportBtn = document.getElementById('export-json-btn');
            const exportModal = document.getElementById('export-json-modal');
            const exportClose = document.getElementById('close-export-json');
            const exportTextarea = document.getElementById('export-json-text');
            const copyAllJsonBtn = document.getElementById('copy-all-json-btn');

            function getScheduleJSON() {
                const itinerary = getCurrentItinerary();
                if (!itinerary || !Array.isArray(itinerary.days) || itinerary.days.length === 0) {
                    alert('暂无行程数据可导出');
                    return '';
                }
                try {
                    return JSON.stringify(itinerary, null, 2);
                } catch (e) {
                    console.error('导出行程JSON失败:', e);
                    alert('导出失败：数据格式错误');
                    return '';
                }
            }
            window.getScheduleJSON = getScheduleJSON;

            function openExportJsonModal() {
                const jsonText = getScheduleJSON();
                if (!jsonText) return;
                if (exportTextarea) exportTextarea.value = jsonText;
                exportModal.style.display = 'flex';
                exportTextarea && exportTextarea.focus();
            }
            function closeExportJsonModal() {
                exportModal.style.display = 'none';
            }

            exportBtn && exportBtn.addEventListener('click', openExportJsonModal);
            exportClose && exportClose.addEventListener('click', closeExportJsonModal);
            copyAllJsonBtn && copyAllJsonBtn.addEventListener('click', async () => {
                const text = (exportTextarea && exportTextarea.value) || '';
                if (!text.trim()) {
                    alert('没有可复制的内容');
                    return;
                }
                try {
                    await navigator.clipboard.writeText(text);
                    alert('已复制到剪切板');
                } catch (err) {
                    try {
                        exportTextarea && exportTextarea.select();
                        document.execCommand('copy');
                        alert('已复制到剪切板');
                    } catch (e) {
                        alert('复制失败：' + e.message);
                    }
                }
            });
        });

        // 拖拽功能实现
        let draggedElement = null;
        let draggedData = null;

        function handleDragStart(event) {
            const item = event.target.closest('.location-item');
            if (!item || item.classList.contains('fixed')) {
                event.preventDefault();
                return;
            }

            draggedElement = item;
            draggedData = {
                date: item.dataset.date,
                index: parseInt(item.dataset.index)
            };

            item.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', item.outerHTML);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';

            const item = event.target.closest('.location-item');
            if (!item || item === draggedElement) return;

            // 移除所有拖拽指示器
            document.querySelectorAll('.location-item').forEach(el => {
                el.classList.remove('drag-over');
            });

            // 添加拖拽指示器
            item.classList.add('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            
            const targetItem = event.target.closest('.location-item');
            if (!targetItem || targetItem === draggedElement) return;

            const targetData = {
                date: targetItem.dataset.date,
                index: parseInt(targetItem.dataset.index)
            };

            // 执行拖拽重排序
            reorderLocations(draggedData, targetData);

            // 清理拖拽状态
            cleanupDragState();
        }

        function handleDragEnd(event) {
            cleanupDragState();
        }

        function cleanupDragState() {
            // 移除所有拖拽相关的样式类
            document.querySelectorAll('.location-item').forEach(el => {
                el.classList.remove('dragging', 'drag-over');
            });
            
            // 移除空区域的拖拽样式
            document.querySelectorAll('.no-locations').forEach(el => {
                el.classList.remove('drag-over');
            });

            draggedElement = null;
            draggedData = null;
        }

        function reorderLocations(sourceData, targetData) {
            if (!itineraryData || !itineraryData.days) return;

            // 找到源天和目标天
            const sourceDay = itineraryData.days.find(day => day.date === sourceData.date);
            const targetDay = itineraryData.days.find(day => day.date === targetData.date);

            if (!sourceDay || !targetDay) return;

            // 获取被拖拽的地点
            const draggedLocation = sourceDay.locations[sourceData.index];
            if (!draggedLocation || draggedLocation.fixed) return;

            // 从源位置移除
            sourceDay.locations.splice(sourceData.index, 1);

            // 如果是同一天内的重排序
            if (sourceData.date === targetData.date) {
                // 调整目标索引（因为已经从源位置移除了一个元素）
                let adjustedTargetIndex = targetData.index;
                if (sourceData.index < targetData.index) {
                    adjustedTargetIndex--;
                }
                
                // 插入到新位置
                targetDay.locations.splice(adjustedTargetIndex, 0, draggedLocation);
            } else {
                // 跨天移动，插入到目标天的指定位置
                targetDay.locations.splice(targetData.index, 0, draggedLocation);
            }

            // 重新计算访问顺序（不进行时间排序）
            [sourceDay, targetDay].forEach(day => {
                if (day.locations) {
                    // 重新分配访问顺序
                    day.locations.forEach((location, index) => {
                        location.visit_order = index + 1;
                    });
                }
            });

            // 重新渲染行程表
            renderItinerary();

            // 保存到localStorage
            localStorage.setItem('manualLocations', JSON.stringify(manualLocations));
        }

        // 处理天级别的拖拽
        function handleDayDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const noLocationsEl = event.currentTarget.querySelector('.no-locations');
            if (noLocationsEl) {
                noLocationsEl.classList.add('drag-over');
            }
            
            // 清理其他位置的拖拽指示器
            document.querySelectorAll('.location-item.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
        }

        function handleDayDrop(event) {
            event.preventDefault();
            
            if (!draggedData) return;
            
            const dayElement = event.currentTarget;
            let dayDate = null;
            
            // 从no-locations元素或location-item元素获取日期
            const noLocationsEl = dayElement.querySelector('.no-locations');
            const locationEl = dayElement.querySelector('.location-item');
            
            if (noLocationsEl) {
                dayDate = noLocationsEl.dataset.date;
            } else if (locationEl) {
                dayDate = locationEl.dataset.date;
            }
            
            if (!dayDate || dayDate === draggedData.date) {
                cleanupDragState();
                return;
            }
            
            // 移动到该天的末尾
            const targetDay = itineraryData.days.find(day => day.date === dayDate);
            if (!targetDay) {
                cleanupDragState();
                return;
            }
            
            const targetIndex = targetDay.locations ? targetDay.locations.length : 0;
            
            reorderLocations(draggedData, {
                date: dayDate,
                index: targetIndex
            });
        }
    </script>

    <style>
        /* 照片展示容器 */
        .poi-photo-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16 / 9;
            height: auto;
        }

        /* 照片框 */
        .poi-photo-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .poi-photo-frame img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            display: none;
        }

        .poi-photo-frame img:first-child {
            display: block; /* 默认显示第一张照片 */
        }

        /* 照片数量指示圆点 */
        .poi-photo-dots {
            position: absolute;
            bottom: 10px; /* 调整到底部位置，位于照片框内、照片底部 */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px; /* 减小间距 */
            z-index: 30; /* 确保圆点在照片上方 */
            background-color: rgba(128, 128, 128, 0.5); /* 背景色改为灰色 */
            padding: 3px 8px; /* 减小内边距 */
            border-radius: 12px; /* 调整圆角 */
        }

        .poi-photo-dot {
            width: 8px; /* 减小圆点大小 */
            height: 8px; /* 减小圆点大小 */
            border-radius: 50%;
            background-color: #fff; /* 空心点为白色 */
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            border: 1px solid #fff; /* 保留白色边框 */
        }

        .poi-photo-dot.active {
            background-color: #2b89ec; /* 实心点为蓝色 */
            transform: scale(1.1); /* 稍微缩小放大比例 */
        }

        /* 翻页按钮 */
        .poi-photo-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0,0,0,0.3);
            color: white;
            border: none;
            font-size: 18px;
            padding: 10px;
            cursor: pointer;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            z-index: 10; /* 确保按钮在照片上方 */
        }

        .poi-photo-nav:hover {
            background-color: rgba(0,0,0,0.5);
        }

        .poi-photo-nav-prev {
            left: 10px;
        }

        .poi-photo-nav-next {
            right: 10px;
        }

        /* 加载提示样式 */
        .loading-message {
            background: linear-gradient(135deg, #e3f2fd, #f8f9fa);
            color: #1565c0;
            margin-left: auto;
            margin-right: auto;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 16px;
            border: 1px solid #bbdefb;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            max-width: 400px;
            animation: loadingPulse 2s ease-in-out infinite;
        }

        /* 加载动画 */
        .loading-dots {
            display: flex;
            gap: 4px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #1976d2;
            animation: loadingDot 1.4s ease-in-out infinite both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loadingDot {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        @keyframes loadingPulse {
            0%, 100% {
                transform: translateY(0);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            50% {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
        }

        /* 加载图标旋转动画 */
        .loading-icon {
            animation: loadingSpin 1s linear infinite;
            font-size: 18px;
            color: #1976d2;
        }

        @keyframes loadingSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 发送按钮加载状态 */
        .input-container button.loading {
            background-color: #90a4ae;
            cursor: not-allowed;
            pointer-events: none;
        }

        .input-container button.loading i {
            animation: loadingSpin 1s linear infinite;
        }

        /* 输入框禁用状态 */
        .input-container textarea:disabled {
            background-color: #f5f5f5;
            color: #9e9e9e;
            cursor: not-allowed;
        }
    </style>

    <script>
        // =====================================
        // 页面配置管理功能
        // =====================================
        
        /**
         * 初始化页面配置 - 简化版本
         */
        async function initializePageConfig() {
            try {
                // 从API加载城市配置
                const response = await fetch('/api/config/city');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.city_config && data.city_config.name) {
                        const cityName = data.city_config.name;
                        
                        // 更新页面标题
                        document.title = `${cityName}旅游助手首页`;
                        // 更新主标题
                        const mainTitle = document.getElementById('main-title');
                        if (mainTitle) {
                            mainTitle.textContent = `${cityName}旅游智能助手`;
                        }
                    }
                }
                
                // 加载旅行目的配置
                await loadAndUpdateTravelPurposes();
                
                // 加载旅游偏好配置
                await loadAndUpdateTravelPreferences();
                
            } catch (error) {
                // 静默处理，使用默认配置
            }
        }

        /**
         * 加载并更新旅行目的选项
         */
        async function loadAndUpdateTravelPurposes() {
            try {
                // 直接从API加载配置
                const apiPurposes = await loadTravelPurposesConfig();
                if (apiPurposes) {
                    updateTravelPurposes(apiPurposes);
                    console.log('从服务器加载旅行目的配置:', apiPurposes.length + '项');
                } else {
                    // 使用默认配置
                    const defaultPurposes = [
                        { name: "休闲度假", icon: "fa-umbrella-beach" },
                        { name: "亲子游玩", icon: "fa-child" },
                        { name: "美食探索", icon: "fa-utensils" },
                        { name: "文化体验", icon: "fa-landmark" },
                        { name: "看演唱会", icon: "fa-music" },
                        { name: "露营", icon: "fa-campground" },
                        { name: "赶海", icon: "fa-water" }
                    ];
                    updateTravelPurposes(defaultPurposes);
                    console.log('使用默认旅行目的配置');
                }
            } catch (error) {
                console.warn('加载旅行目的配置失败:', error);
            }
        }
        
        /**
         * 从后端API加载城市配置
         */
        async function loadCityConfig() {
            try {
                const response = await fetch('/api/config/city', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data && data.data.city_config) {
                        const cityName = data.data.city_config.name;
                        console.log('从API加载城市配置:', cityName);
                        return { name: cityName };
                    }
                }
                
                // API失败，使用默认值
                console.log('API加载失败，使用默认城市配置');
                return { name: '海口' };
                
            } catch (error) {
                console.warn('加载城市配置失败:', error);
                return { name: '海口' };
            }
        }
        
        /**
         * 从后端API加载旅行目的配置
         */
        async function loadTravelPurposesConfig() {
            try {
                const response = await fetch('/api/config/travel_purposes', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.travel_purposes) {
                        const purposes = data.travel_purposes;
                        console.log('从API加载旅行目的配置:', purposes.length + '项');
                        return purposes;
                    }
                }
                
                // API失败，返回null让页面保持默认HTML
                console.log('API加载失败，保持默认旅行目的选项');
                return null;
                
            } catch (error) {
                console.warn('加载旅行目的配置失败:', error);
                return null;
            }
        }
        
        /**
         * 加载并更新旅游偏好选项
         */
        async function loadAndUpdateTravelPreferences() {
            try {
                // 从API加载配置
                const apiPreferences = await loadTravelPreferencesConfig();
                if (apiPreferences) {
                    updateTravelPreferences(apiPreferences);
                    console.log('从服务器加载旅游偏好配置:', Object.keys(apiPreferences).length + '类');
                } else {
                    console.warn('无法加载旅游偏好配置');
                }
            } catch (error) {
                console.warn('加载旅游偏好配置失败:', error);
            }
        }
        
        /**
         * 从后端API加载旅游偏好配置
         */
        async function loadTravelPreferencesConfig() {
            try {
                const response = await fetch('/api/config/travel_preferences', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.travel_preferences) {
                        const preferences = data.travel_preferences;
                        console.log('从API加载旅游偏好配置');
                        return preferences;
                    }
                }
                
                // API失败，返回null让页面保持默认HTML
                console.log('API加载失败，保持默认旅游偏好选项');
                return null;
                
            } catch (error) {
                console.warn('加载旅游偏好配置失败:', error);
                return null;
            }
        }
        
        /**
         * 更新旅游偏好选项
         */
        function updateTravelPreferences(preferences) {
            try {
                // 使用扁平化格式：直接的类别对象
                updateTravelPreferencesFlatFormat(preferences);
                console.log('旅游偏好选项已更新');
            } catch (error) {
                console.error('更新旅游偏好失败:', error);
            }
        }

        /**
         * 更新旅游偏好（扁平化格式）
         */
        function updateTravelPreferencesFlatFormat(preferences) {
            // 检查是否有任何偏好配置
            if (!preferences || Object.keys(preferences).length === 0) {
                // 没有偏好配置，隐藏区域
                hideTravelPreferencesSection();
                return;
            }
            
            // 有偏好配置，显示区域
            showTravelPreferencesSection();
            
            // 清空现有的偏好区域（保留标题）
            const preferenceContainer = document.querySelector('.preferences-group');
            if (!preferenceContainer) return;
            
            // 保留现有的标题
            const existingTitle = preferenceContainer.querySelector('.section-label');
            preferenceContainer.innerHTML = '';
            if (existingTitle) {
                preferenceContainer.appendChild(existingTitle);
            }
            
            // 为每个类别创建偏好组
            Object.entries(preferences).forEach(([categoryName, items]) => {
                createPreferenceGroupFlat(categoryName, items);
            });
        }

        /**
         * 创建偏好组（扁平化格式）
         */
        function createPreferenceGroupFlat(categoryName, items) {
            const preferenceContainer = document.querySelector('.preferences-group');
            if (!preferenceContainer) return;
            
            // 创建偏好组容器
            const groupDiv = document.createElement('div');
            groupDiv.className = 'preference-item';
            groupDiv.id = `${categoryName.replace(/\s+/g, '-')}-group`;
            
            // 获取已保存的图标，默认为星形图标
            const savedIcon = localStorage.getItem(`preference_icon_${categoryName}`) || 'fas fa-star';
            
            // 创建标题
            const titleDiv = document.createElement('div');
            titleDiv.className = 'preference-title';
            titleDiv.innerHTML = `<i class="${savedIcon}"></i> ${categoryName}`;
            
            // 创建选项容器
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'checkbox-group';
            
            // 生成选项
            items.forEach((item, index) => {
                const label = document.createElement('label');
                label.className = 'checkbox-item';
                
                if (typeof item === 'string') {
                    // 普通选项
                    const checkboxId = `${categoryName}-${index}`;
                    label.innerHTML = `
                        <input type="checkbox" name="${categoryName}" value="${item}" id="${checkboxId}">
                        <span>${item}</span>
                    `;
                } else if (item.type === 'input') {
                    // 用户输入项
                    const customId = `${categoryName}-custom-${index}`;
                    const customInputId = `${categoryName}-input-${index}`;
                    
                    // 修改label结构，支持内部输入框
                    label.style.flexDirection = 'column';
                    label.style.alignItems = 'flex-start';
                    
                    // 创建复选框行
                    const checkboxRow = document.createElement('div');
                    checkboxRow.style.display = 'flex';
                    checkboxRow.style.alignItems = 'center';
                    checkboxRow.style.width = '100%';
                    checkboxRow.innerHTML = `
                        <input type="checkbox" name="${categoryName}" value="${item.name}" id="${customId}">
                        <span>${item.name}</span>
                    `;
                    
                    // 创建自定义输入框
                    const customInputContainer = document.createElement('div');
                    customInputContainer.className = 'custom-input-container';
                    customInputContainer.style.display = 'none';
                    customInputContainer.innerHTML = `
                        <input type="text" 
                               id="${customInputId}" 
                               name="${categoryName}-custom" 
                               placeholder="${item.placeholder || '请输入具体内容'}" 
                               class="custom-input">
                    `;
                    
                    label.appendChild(checkboxRow);
                    label.appendChild(customInputContainer);
                    
                    // 添加事件监听器
                    const checkbox = checkboxRow.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            customInputContainer.style.display = 'block';
                            customInputContainer.querySelector('input').focus();
                        } else {
                            customInputContainer.style.display = 'none';
                            customInputContainer.querySelector('input').value = '';
                        }
                    });
                }
                
                optionsDiv.appendChild(label);
            });
            
            // 组装偏好组
            groupDiv.appendChild(titleDiv);
            groupDiv.appendChild(optionsDiv);
            preferenceContainer.appendChild(groupDiv);
        }

        /**
         * 隐藏旅游偏好区域
         */
        function hideTravelPreferencesSection() {
            const preferencesFormGroup = document.querySelector('.preferences-group').closest('.form-group');
            if (preferencesFormGroup) {
                preferencesFormGroup.style.display = 'none';
                console.log('已隐藏旅游偏好区域：没有可用的偏好类别');
            }
        }

        /**
         * 显示旅游偏好区域
         */
        function showTravelPreferencesSection() {
            const preferencesFormGroup = document.querySelector('.preferences-group').closest('.form-group');
            if (preferencesFormGroup) {
                preferencesFormGroup.style.display = 'block';
                console.log('已显示旅游偏好区域');
            }
        }
        
        /**
         * 更新页面标题
         */
        function updatePageTitle(cityName) {
            try {
                console.log('开始更新页面标题，城市名称:', cityName);
                
                if (!cityName || typeof cityName !== 'string') {
                    console.warn('城市名称无效，使用默认值');
                    cityName = '海口';
                }
                
                const newTitle = `${cityName}旅游智能助手`;
                const newPageTitle = `${cityName}市内旅游助手首页`;
                
                // 更新浏览器标题
                document.title = newPageTitle;
                console.log('浏览器标题已更新为:', newPageTitle);
                
                // 更新页面主标题 - 使用ID选择器更精确
                const mainTitle = document.getElementById('main-title');
                if (mainTitle) {
                    mainTitle.textContent = newTitle;
                    console.log('主标题已更新为:', newTitle);
                } else {
                    // 备用方案：使用class选择器
                    const mainTitleByClass = document.querySelector('.main-title');
                    if (mainTitleByClass) {
                        mainTitleByClass.textContent = newTitle;
                        console.log('主标题已更新为(通过class):', newTitle);
                    } else {
                        console.error('未找到主标题元素');
                    }
                }
                
                // 同时更新head中的title元素（如果有ID的话）
                const pageTitle = document.getElementById('page-title');
                if (pageTitle) {
                    pageTitle.textContent = newPageTitle;
                    console.log('页面title元素已更新');
                }
                
                console.log('页面标题更新完成');
            } catch (error) {
                console.error('更新页面标题失败:', error);
            }
        }
        
        /**
         * 更新旅行目的选项
         */
        function updateTravelPurposes(purposes) {
            try {
                const checkboxGroup = document.querySelector('.checkbox-group');
                if (!checkboxGroup) {
                    console.warn('未找到旅行目的选择区域');
                    return;
                }
                
                // 保留"其他"选项的HTML
                const otherOption = checkboxGroup.querySelector('#other-purpose-checkbox')?.parentElement;
                const otherInput = document.getElementById('other-purpose-input');
                
                // 清空现有选项（除了"其他"）
                const existingOptions = checkboxGroup.querySelectorAll('.checkbox-item');
                existingOptions.forEach(option => {
                    if (!option.querySelector('#other-purpose-checkbox')) {
                        option.remove();
                    }
                });
                
                // 添加新的旅行目的选项
                purposes.forEach(purpose => {
                    const label = document.createElement('label');
                    label.className = 'checkbox-item';
                    label.innerHTML = `
                        <input type="checkbox" name="travel-purpose" value="${purpose.name}">
                        <span>${purpose.name}</span>
                    `;
                    
                    // 在"其他"选项之前插入
                    if (otherOption) {
                        checkboxGroup.insertBefore(label, otherOption);
                    } else {
                        checkboxGroup.appendChild(label);
                    }
                });
                
                console.log('旅行目的选项已更新:', purposes.length + '项');
            } catch (error) {
                console.error('更新页面标题失败:', error);
            }
        }
        
        /**
         * 更新旅行目的选项
         */
        function updateTravelPurposes(purposes) {
            try {
                const checkboxGroup = document.querySelector('.checkbox-group');
                if (!checkboxGroup) {
                    console.warn('未找到旅行目的选择区域');
                    return;
                }
                
                // 保留"其他"选项的HTML
                const otherOption = checkboxGroup.querySelector('#other-purpose-checkbox')?.parentElement;
                const otherInput = document.getElementById('other-purpose-input');
                
                // 清空现有选项（除了"其他"）
                const existingOptions = checkboxGroup.querySelectorAll('.checkbox-item');
                existingOptions.forEach(option => {
                    if (!option.querySelector('#other-purpose-checkbox')) {
                        option.remove();
                    }
                });
                
                // 添加新的旅行目的选项
                purposes.forEach(purpose => {
                    const label = document.createElement('label');
                    label.className = 'checkbox-item';
                    label.innerHTML = `
                        <input type="checkbox" name="travel-purpose" value="${purpose.name}">
                        <span>${purpose.name}</span>
                    `;
                    
                    // 在"其他"选项之前插入
                    if (otherOption) {
                        checkboxGroup.insertBefore(label, otherOption);
                    } else {
                        checkboxGroup.appendChild(label);
                    }
                });
                
                console.log('旅行目的选项已更新:', purposes.length + '项');
            } catch (error) {
                console.error('更新旅行目的选项失败:', error);
            }
        }
        
        /**
         * 手动刷新配置（可供其他代码调用）
         */
        window.refreshPageConfig = function() {
            console.log('手动刷新页面配置...');
            return initializePageConfig();
        };
        
        // =====================================
        // 地图功能管理
        // =====================================
        
        /**
         * 初始化地图功能
         */
        function initializeMapFeature() {
            const mapFloatBtn = document.getElementById('map-float-btn');
            const mapContainer = document.getElementById('map-container');
            const mapCloseBtn = document.getElementById('map-close-btn');
            
            if (!mapFloatBtn || !mapContainer || !mapCloseBtn) {
                console.warn('地图组件元素未找到');
                return;
            }
            
            // 地图浮标按钮点击事件
            mapFloatBtn.addEventListener('click', function() {
                toggleMap();
            });
            
            // 地图关闭按钮点击事件
            mapCloseBtn.addEventListener('click', function() {
                hideMap();
            });
            
            console.log('地图功能初始化完成');
        }
        
        /**
         * 切换地图显示/隐藏
         */
        function toggleMap() {
            const mapContainer = document.getElementById('map-container');
            if (!mapContainer) return;
            
            if (mapContainer.classList.contains('map-hidden')) {
                showMap();
            } else {
                hideMap();
            }
        }
        
        /**
         * 显示地图
         */
        function showMap() {
            const mapContainer = document.getElementById('map-container');
            if (!mapContainer) return;
            
            mapContainer.classList.remove('map-hidden');
            console.log('地图已显示');
        }
        
        /**
         * 隐藏地图
         */
        function hideMap() {
            const mapContainer = document.getElementById('map-container');
            if (!mapContainer) return;
            
            mapContainer.classList.add('map-hidden');
            console.log('地图已隐藏');
        }
        
        // 地图浮窗布局：根据左侧栏折叠状态自适应宽度
        function syncMapPanelLayout() {
            const left = document.getElementById('left-column');
            const right = document.getElementById('right-column');
            const map = document.getElementById('map-container');
            if (!left || !right || !map) return;

            const apply = () => {
                const collapsed = left.classList.contains('collapsed');
                document.body.classList.toggle('left-collapsed', collapsed);
                // 将地图浮窗宽度同步为右侧聊天窗口的可用宽度
                const width = right.clientWidth;
                if (width && width > 0) {
                    map.style.width = width + 'px';
                }
            };

            // 初始应用一次
            apply();

            // 监听左侧栏折叠状态变化
            const observer = new MutationObserver(apply);
            observer.observe(left, { attributes: true, attributeFilter: ['class'] });

            // 窗口尺寸变化时重新计算
            window.addEventListener('resize', apply);
        }

        // 页面载入完成后初始化地图功能与布局适配
        document.addEventListener('DOMContentLoaded', function() {
            initializeMapFeature();
            syncMapPanelLayout();
        });

        // 页面载入完成后的调试信息
        console.log(`=== ${getCurrentCityName()}旅游助手页面载入完成 ===`);
        console.log('可用的调试函数:');
        console.log('  - debugPrintFunction(): 完整的打印功能调试');
        console.log('  - testPrintDirectly(): 直接测试打印功能');
        console.log('  - generatePrintableItinerary(): 手动调用打印');
        console.log('  - getCurrentItinerary(): 获取当前行程数据');
        console.log('  - toggleMap(): 切换地图显示/隐藏');
        console.log('  - showMap(): 显示地图');
        console.log('  - hideMap(): 隐藏地图');
        console.log('');
        console.log('使用方法: 在控制台中输入 debugPrintFunction() 开始调试');
    </script>
</body>

</html>